<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Earning App - Withdrawal System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding-bottom: 70px;
        }
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }
        .profile-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #667eea;
        }
        .user-info {
            margin-left: 15px;
            flex-grow: 1;
        }
        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .user-phone {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .user-id {
            color: #888;
            font-size: 12px;
        }
        .balance-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            padding: 15px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .balance-item {
            text-align: center;
            flex: 1;
        }
        .balance-label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .balance-amount {
            font-size: 20px;
            font-weight: 700;
        }
        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        .app-button {
            background: white;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #eee;
        }
        .app-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .app-button i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #667eea;
        }
        .app-button .button-text {
            font-size: 14px;
            font-weight: 600;
        }
        .navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            max-width: 480px;
            margin: 0 auto;
            z-index: 100;
        }
        .nav-item {
            text-align: center;
            color: #666;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item i {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }
        .nav-item.active {
            color: #667eea;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .history-date {
            color: #888;
            font-size: 12px;
        }
        .history-amount {
            font-weight: 600;
        }
        .withdrawal-options {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .withdrawal-option {
            text-align: center;
            flex: 1;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 0 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .withdrawal-option.selected {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .withdrawal-option i {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 10px;
        }
        h2 {
            margin: 20px 0 15px 0;
            color: #444;
            font-size: 20px;
        }
        .referral-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .referral-link {
            display: flex;
            margin: 15px 0;
        }
        .referral-link input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
        }
        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
        }
        .team-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #888;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .submit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .withdraw-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            display: block;
            width: 100%;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending {
            background: #fff4e5;
            color: #ffa800;
        }
        .status-processing {
            background: #e1f5fe;
            color: #039be5;
        }
        .status-success {
            background: #e8f5e9;
            color: #4caf50;
        }
        .status-rejected {
            background: #ffebee;
            color: #f44336;
        }
        .min-amount {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .ad-container {
            margin: 20px 0;
            text-align: center;
        }
        .reward-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .coins-earned {
            font-size: 18px;
            font-weight: bold;
        }
        .ad-button-container {
            text-align: center;
            margin: 20px 0;
        }
        .watch-ad-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .watch-ad-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .watch-ad-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* Back to Home Button - Small and Top Right */
        .back-to-home-small {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 90;
            display: none;
            transition: all 0.3s ease;
        }
        .back-to-home-small:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        .back-to-home-small i {
            margin-right: 5px;
        }
        /* Block Page Styles */
        .block-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 15px;
        }
        .block-content {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .block-content h2 {
            color: #ff6b6b;
            margin-bottom: 15px;
        }
        .telegram-link {
            display: inline-block;
            background: linear-gradient(45deg, #4361ee, #3f37c9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        .telegram-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
        }
        .telegram-link i {
            margin-right: 8px;
        }
        /* Coin to BDT Conversion Info */
        .conversion-info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        .conversion-info strong {
            color: #1976d2;
        }
        /* Team Page Styles - Updated */
        .team-invite-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }
        .invite-link-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .invite-link {
            word-break: break-all;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 15px;
        }
        .copy-invite-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .team-members-list {
            margin-top: 20px;
        }
        .team-member {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            font-size: 16px;
        }
        .member-info {
            flex-grow: 1;
        }
        .member-name {
            font-weight: 600;
            font-size: 14px;
        }
        .member-date {
            font-size: 12px;
            color: #888;
        }
        .member-earnings {
            font-weight: 600;
            color: #4caf50;
        }
        .team-limit-info {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-size: 13px;
        }
        .team-limit-info strong {
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home Page -->
        <div class="page active" id="home-page">
            <div class="header">
                <img src="https://via.placeholder.com/70" alt="Profile" class="profile-img" id="user-profile-img">
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-phone" id="user-phone">Loading...</div>
                    <div class="user-id" id="user-id">ID: Loading...</div>
                </div>
            </div>
            <div class="balance-container">
                <div class="balance-item">
                    <div class="balance-label">Balance</div>
                    <div class="balance-amount">৳ <span id="balance-amount">0.00</span></div>
                </div>
                <div class="balance-item">
                    <div class="balance-label">Coins</div>
                    <div class="balance-amount"><span id="coin-amount">0</span> <i class="fas fa-coins" style="color: gold;"></i></div>
                </div>
            </div>
            <div class="conversion-info">
                <i class="fas fa-info-circle"></i> <strong>Conversion Rate:</strong> 1000 coins = ৳1.00<br>
                <small>Coins convert to BDT automatically at 12:00 AM (Bangladesh Time)</small>
            </div>
            <div class="buttons-grid">
                <div class="app-button" id="ad-button">
                    <i class="fas fa-ad"></i>
                    <div class="button-text">Watch Ads</div>
                </div>
                <div class="app-button" id="team-button">
                    <i class="fas fa-users"></i>
                    <div class="button-text">Team</div>
                </div>
                <div class="app-button">
                    <i class="fas fa-gift"></i>
                    <div class="button-text">Rewards</div>
                </div>
                <div class="app-button">
                    <i class="fas fa-tasks"></i>
                    <div class="button-text">Daily Tasks</div>
                </div>
                <div class="app-button">
                    <i class="fas fa-share-alt"></i>
                    <div class="button-text">Invite Friends</div>
                </div>
                <div class="app-button">
                    <i class="fas fa-cog"></i>
                    <div class="button-text">Settings</div>
                </div>
            </div>
        </div>
        <!-- Watch Ads Page -->
        <div class="page" id="ads-page">
            <h2>Watch Ads to Earn</h2>
            <p>Watch advertisements to earn money. Each ad view gives you <strong>50 coins</strong>!</p>
            <div class="ad-button-container">
                <button class="watch-ad-btn" id="watch-ad-btn">
                    <i class="fas fa-play-circle"></i> Watch Ad & Earn 50 Coins
                </button>
            </div>
            <button class="back-to-home-small" id="back-to-home-top">
                <i class="fas fa-arrow-left"></i> Home
            </button>
        </div>
        <!-- Team Page -->
        <div class="page" id="team-page">
            <h2>Team</h2>
            <!-- Removed the "How Team Sharing Works" explanation section -->
            <div class="team-invite-section">
                <h3>Invite Friends & Earn</h3>
                <p>Share your referral link with friends. You'll earn 10% of their earnings!</p>
                <!-- Removed the "Important: Each account can be shared with up to 14 other users." line -->
                <div class="invite-link-container">
                    <div class="invite-link" id="invite-link">
                        Loading your invite link...
                    </div>
                    <button class="copy-invite-btn" id="copy-invite-btn">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
                <div class="team-limit-info">
                    <i class="fas fa-exclamation-circle"></i> <strong>Team Limit:</strong> You can share your account with up to <strong>14</strong> other users. Total capacity: <strong>15</strong> users (including you).
                </div>
                <div class="team-stats">
                    <div class="stat-box">
                        <div class="stat-label">Team Members</div>
                        <div class="stat-value"><span id="team-members-count">0</span>/14</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Earnings</div>
                        <div class="stat-value">৳ <span id="team-earnings">0.00</span></div>
                    </div>
                </div>
            </div>
            <div class="team-members-list" id="team-members-list">
                <p style="text-align: center; color: #888;">No team members yet</p>
            </div>
        </div>
        <!-- Rewards Page -->
        <div class="page" id="rewards-page">
            <h2>Rewards</h2>
            <p>Rewards content will be here.</p>
        </div>
        <!-- History Page -->
        <div class="page" id="history-page">
            <h2>Withdrawal History</h2>
            <div class="history-list" id="withdrawal-history">
                <p style="text-align: center; padding: 20px; color: #888;">No withdrawal history</p>
            </div>
        </div>
        <!-- Profile Page -->
        <div class="page" id="profile-page">
            <h2>Profile Information</h2>
            <div class="header">
                <img src="https://via.placeholder.com/70" alt="Profile" class="profile-img" id="profile-user-img">
                <div class="user-info">
                    <div class="user-name" id="profile-user-name">Loading...</div>
                    <div class="user-phone" id="profile-user-phone">Loading...</div>
                    <div class="user-id" id="profile-user-id">ID: Loading...</div>
                </div>
            </div>
            <h2>Withdrawal Methods</h2>
            <div class="withdrawal-options">
                <div class="withdrawal-option" data-method="bkash">
                    <i class="fas fa-mobile-alt"></i>
                    <div>bKash</div>
                </div>
                <div class="withdrawal-option" data-method="nagad">
                    <i class="fas fa-university"></i>
                    <div>Nagad</div>
                </div>
                <div class="withdrawal-option" data-method="rocket">
                    <i class="fas fa-rocket"></i>
                    <div>Rocket</div>
                </div>
            </div>
            <button class="withdraw-btn" id="open-withdraw-modal-profile">
                <i class="fas fa-money-bill-wave"></i> Withdraw Money
            </button>
            <h2>Referral Program</h2>
            <div class="referral-box">
                <p>Invite friends and earn 10% of their earnings!</p>
                <div class="referral-link">
                    <input type="text" id="referral-input" value="https://t.me/earningappbot?start=" readonly>
                    <button class="copy-btn" id="copy-btn"><i class="fas fa-copy"></i></button>
                </div>
                <p>Your team: <strong><span id="team-count">0</span> users</strong></p>
            </div>
            <div class="team-stats">
                <div class="stat-box">
                    <div class="stat-label">Total Earnings</div>
                    <div class="stat-value">৳ <span id="total-earnings">0.00</span></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Team Size</div>
                    <div class="stat-value"><span id="profile-team-size">0</span></div>
                </div>
            </div>
            <div class="app-version">
                <p style="text-align: center; color: #888; margin: 20px 0;">App Version: 1.0.0</p>
            </div>
        </div>
        <!-- Withdrawal Modal -->
        <div class="modal-overlay" id="withdraw-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Withdraw Money</h3>
                    <button class="close-modal" id="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Select Method</label>
                    <div class="withdrawal-options">
                        <div class="withdrawal-option" data-method="bkash">
                            <i class="fas fa-mobile-alt"></i>
                            <div>bKash</div>
                        </div>
                        <div class="withdrawal-option" data-method="nagad">
                            <i class="fas fa-university"></i>
                            <div>Nagad</div>
                        </div>
                        <div class="withdrawal-option" data-method="rocket">
                            <i class="fas fa-rocket"></i>
                            <div>Rocket</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="phone-number">Phone Number</label>
                    <input type="tel" class="form-input" id="phone-number" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label class="form-label" for="amount">Amount (৳)</label>
                    <input type="number" class="form-input" id="amount" placeholder="Enter amount">
                    <div class="min-amount">Minimum withdrawal: ৳100</div>
                </div>
                <button class="submit-btn" id="submit-withdrawal" disabled>
                    Submit Withdrawal Request
                </button>
            </div>
        </div>
        <!-- Reward Notification -->
        <div class="reward-notification" id="reward-notification">
            <div>Congratulations!</div>
            <div class="coins-earned">You earned 50 coins!</div>
        </div>
    </div>
    <div class="navigation">
        <div class="nav-item active" data-page="home-page">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" data-page="team-page">
            <i class="fas fa-users"></i>
            <span>Team</span>
        </div>
        <div class="nav-item" data-page="rewards-page">
            <i class="fas fa-gift"></i>
            <span>Rewards</span>
        </div>
        <div class="nav-item" data-page="history-page">
            <i class="fas fa-history"></i>
            <span>History</span>
        </div>
        <div class="nav-item" data-page="profile-page">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </div>
    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Monetag SDK - Updated with your new zone ID -->
    <script src='//libtl.com/sdk.js' data-zone='9753772' data-sdk='show_9753772'></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3BGZ0MVLpbQbIpLUAnYvWNEIyk7Y6S0Q",
            authDomain: "earning-app-80258.firebaseapp.com",
            databaseURL: "https://earning-app-80258-default-rtdb.firebaseio.com",
            projectId: "earning-app-80258",
            storageBucket: "earning-app-80258.appspot.com",
            messagingSenderId: "25930019210",
            appId: "1:25930019210:web:6441562811d3e7e9631873",
            measurementId: "G-P9HX6XXT1Q"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        console.log("Firebase initialized successfully");
        // Global variables
        let selectedMethod = null;
        let currentUser = null;
        let userRef = null;
        let adLoaded = false;
        const COINS_PER_AD = 50; // Define coins earned per ad view
        const COINS_TO_BDT_RATE = 1000; // 1000 coins = 1 BDT
        let isAdRunning = false; // Flag to prevent multiple ad requests
        const BOT_USERNAME = "TKBD5_bot"; // Your Telegram bot username
        const MAX_TEAM_MEMBERS = 14; // Maximum team members per account
        let isSharedSession = false; // Flag to indicate if this is a shared session
        let originalUserRef = null; // Reference to the original user's data in case of shared session
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthState();
            startDailyConversionTimer();
            // Check for referral on app start (for Telegram Mini Apps)
            checkForReferralOnStart();
        });
        function checkForReferralOnStart() {
            // For Telegram Mini Apps, check the start parameter
            const initData = window.Telegram?.WebApp?.initDataUnsafe;
            if (initData && initData.start_param) {
                const startParam = initData.start_param;
                console.log("Start parameter detected:", startParam);
                if (startParam.startsWith('shared_')) {
                    const originalUserId = startParam.substring(7); // Remove 'shared_' prefix
                    console.log("Shared session detected. Original User ID:", originalUserId);
                    // Handle the shared account access
                    handleSharedAccountAccess(originalUserId);
                }
            }
        }
        function handleSharedAccountAccess(originalUserId) {
            if (!originalUserId) {
                console.log("Invalid original user ID for shared session.");
                return;
            }
            // Prevent self-referral
            const currentUserId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id?.toString();
            if (!currentUserId) {
                console.log("Could not get current Telegram user ID.");
                return;
            }
            if (originalUserId === currentUserId) {
                console.log("Cannot share account with yourself.");
                return;
            }
            // Find the original user account
            const origUserRef = database.ref('users/' + originalUserId);
            origUserRef.once('value').then(snapshot => {
                const originalData = snapshot.val();
                if (originalData) {
                    // Check if this account can accept more shared users
                    const currentSharedCount = originalData.sharedWith ? originalData.sharedWith.length : 0;
                    if (currentSharedCount < MAX_TEAM_MEMBERS) {
                        // Check if current user is already added to avoid duplicates
                        const isAlreadyAdded = originalData.sharedWith && 
                            originalData.sharedWith.some(member => member.userId == currentUserId);
                        if (!isAlreadyAdded) {
                            // Add current user to the shared list
                            const sharedWith = originalData.sharedWith || [];
                            sharedWith.push({
                                userId: currentUserId,
                                joinedAt: new Date().toISOString()
                                // Add other relevant info if needed
                            });
                            // Update original user's data
                            return origUserRef.update({
                                sharedWith: sharedWith,
                                teamMembers: sharedWith.length
                            }).then(() => {
                                console.log(`Successfully added ${currentUserId} to ${originalUserId}'s team.`);
                                // Set flags for shared session
                                isSharedSession = true;
                                originalUserRef = origUserRef; // Store reference to original user's data
                                // Load the original user's data for the current user (synced session)
                                loadUserData(origUserRef);
                                // Update UI to reflect shared session
                                updateUIForSharedSession(originalUserId);
                            });
                        } else {
                            console.log("User is already part of this team.");
                            // Still load original user's data
                            isSharedSession = true;
                            originalUserRef = origUserRef;
                            loadUserData(origUserRef);
                            updateUIForSharedSession(originalUserId);
                        }
                    } else {
                        console.log("This account has reached its maximum sharing limit (14 users).");
                        alert('This account has reached its maximum sharing limit (14 users).');
                        // Proceed with normal user flow or show error
                    }
                } else {
                    console.log("Original user account not found:", originalUserId);
                    alert('Invalid referral link.');
                    // Proceed with normal user flow or show error
                }
            }).catch(error => {
                console.error("Error accessing shared account:", error);
                alert('Error processing referral link.');
                // Proceed with normal user flow or show error
            });
        }
        function updateUIForSharedSession(originalUserId) {
            // Update UI elements to indicate this is a shared session
            console.log("User is now part of a shared session for user:", originalUserId);
            // You can add visual indicators here if needed
        }
        function checkAuthState() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    userRef = database.ref('users/' + user.uid);
                    loadUserData();
                    listenForWithdrawalUpdates();
                } else {
                    // Redirect to login or show login UI
                    showLoginUI();
                }
            });
        }
        function showLoginUI() {
            // For demo purposes, we'll simulate a login
            // In a real app, you would redirect to a login page or show FirebaseUI
            console.log("User not logged in");
            // Simulate login for demo
            simulateLogin();
        }
        function simulateLogin() {
            // Check if we're in Telegram WebApp
            const tg = window.Telegram?.WebApp;
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                // Use Telegram user data
                const tgUser = tg.initDataUnsafe.user;
                const userId = tgUser.id.toString();
                const displayName = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
                const username = tgUser.username || 'telegram_user';
                const photoUrl = tgUser.photo_url || 'https://via.placeholder.com/70';
                
                // Set current user with Telegram data
                currentUser = {
                    uid: userId,
                    displayName: displayName,
                    phoneNumber: 'N/A', // Telegram doesn't provide phone number
                    photoURL: photoUrl
                };
                
                userRef = database.ref('users/' + userId);
                
                // Initialize user data if not exists
                userRef.once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        const initialData = {
                            balance: 0,
                            coins: 0,
                            teamMembers: 0,
                            totalEarnings: 0,
                            referralCode: userId,
                            createdAt: new Date().toISOString(),
                            lastConversionDate: new Date().toISOString().split('T')[0], // Track last conversion date
                            sharedWith: [], // Array to track who this account is shared with
                            telegramData: {
                                id: tgUser.id,
                                first_name: tgUser.first_name,
                                last_name: tgUser.last_name,
                                username: tgUser.username,
                                photo_url: tgUser.photo_url
                            }
                        };
                        return userRef.set(initialData);
                    }
                }).then(() => {
                    loadUserData();
                    listenForWithdrawalUpdates();
                    // Update UI with Telegram user data
                    updateUIWithTelegramUserData(tgUser);
                });
            } else {
                // Generate a random user ID for demo (fallback)
                const userId = 'user_' + Math.random().toString(36).substr(2, 9);
                const user = {
                    uid: userId,
                    displayName: 'Demo User',
                    phoneNumber: '+8801XXXXXXXXX',
                    photoURL: 'https://via.placeholder.com/70'
                };
                currentUser = user;
                userRef = database.ref('users/' + userId);
                // Initialize user data if not exists
                userRef.once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        const initialData = {
                            balance: 0,
                            coins: 0,
                            teamMembers: 0,
                            totalEarnings: 0,
                            referralCode: userId,
                            createdAt: new Date().toISOString(),
                            lastConversionDate: new Date().toISOString().split('T')[0], // Track last conversion date
                            sharedWith: [] // Array to track who this account is shared with
                        };
                        return userRef.set(initialData);
                    }
                }).then(() => {
                    loadUserData();
                    listenForWithdrawalUpdates();
                });
            }
        }
        // Function to update UI with Telegram user data
        function updateUIWithTelegramUserData(tgUser) {
            if (!tgUser) return;
            
            // Update profile image
            if (tgUser.photo_url) {
                document.getElementById('user-profile-img').src = tgUser.photo_url;
                document.getElementById('profile-user-img').src = tgUser.photo_url;
            }
            
            // Update user name
            const displayName = tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '');
            document.getElementById('user-name').textContent = displayName;
            document.getElementById('profile-user-name').textContent = displayName;
            
            // Update user ID
            document.getElementById('user-id').textContent = 'ID: ' + tgUser.id;
            document.getElementById('profile-user-id').textContent = 'ID: ' + tgUser.id;
            
            // Update username if available
            if (tgUser.username) {
                document.getElementById('user-phone').textContent = '@' + tgUser.username;
                document.getElementById('profile-user-phone').textContent = '@' + tgUser.username;
            }
        }
        function loadUserData(ref = null) {
            let dataRef = ref || userRef; // Use provided reference or default userRef
            if (!dataRef) return;
            // Remove any existing listeners to prevent conflicts
            if (userRef) {
                userRef.off('value');
            }
            if (originalUserRef) {
                originalUserRef.off('value');
            }
            dataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUIWithUserData(data);
                    // Check if user is blocked
                    if (data.isBlocked) {
                        document.getElementById('blockPage').style.display = 'flex';
                        // Disable all buttons except those in block page
                        document.querySelectorAll('button:not(.telegram-link)').forEach(btn => {
                            btn.disabled = true;
                        });
                    } else {
                        document.getElementById('blockPage').style.display = 'none';
                        // Enable all buttons
                        document.querySelectorAll('button').forEach(btn => {
                            btn.disabled = false;
                        });
                    }
                }
            });
        }
        function updateUIWithUserData(data) {
            // Update home page
            document.getElementById('user-name').textContent = currentUser.displayName || 'User';
            document.getElementById('user-phone').textContent = data.phoneNumber || 'N/A';
            document.getElementById('user-id').textContent = 'ID: ' + (currentUser.uid || 'N/A');
            document.getElementById('balance-amount').textContent = (data.balance || 0).toFixed(2);
            document.getElementById('coin-amount').textContent = data.coins || 0;
            
            // Update profile image if available
            if (currentUser.photoURL) {
                document.getElementById('user-profile-img').src = currentUser.photoURL;
                document.getElementById('profile-user-img').src = currentUser.photoURL;
            }
            
            // Update profile page
            document.getElementById('profile-user-name').textContent = currentUser.displayName || 'User';
            document.getElementById('profile-user-phone').textContent = data.phoneNumber || 'N/A';
            document.getElementById('profile-user-id').textContent = 'ID: ' + (currentUser.uid || 'N/A');
            document.getElementById('total-earnings').textContent = (data.totalEarnings || 0).toFixed(2);
            document.getElementById('profile-team-size').textContent = data.teamMembers || 0;
            document.getElementById('team-count').textContent = data.teamMembers || 0;
            
            // Update team page
            document.getElementById('team-page-size').textContent = data.teamMembers || 0;
            
            // Update referral link
            document.getElementById('referral-input').value = 'https://t.me/' + BOT_USERNAME + '?start=' + (data.referralCode || '');
            
            // Update team page specific elements
            updateTeamPage(data);
        }
        function updateTeamPage(data) {
            // Create unique invite link for this user
            const inviteLink = 'https://t.me/' + BOT_USERNAME + '?start=shared_' + (currentUser.uid || '');
            document.getElementById('invite-link').textContent = inviteLink;
            
            // Update team stats
            const teamMembersCount = data.sharedWith ? data.sharedWith.length : 0;
            document.getElementById('team-members-count').textContent = teamMembersCount;
            document.getElementById('team-earnings').textContent = (data.totalEarningsFromTeam || 0).toFixed(2);
            
            // Update team members list
            const teamMembersList = document.getElementById('team-members-list');
            teamMembersList.innerHTML = '';
            if (data.sharedWith && data.sharedWith.length > 0) {
                data.sharedWith.forEach((member, index) => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'team-member';
                    memberElement.innerHTML = `
                        <div class="member-avatar">${index + 1}</div>
                        <div class="member-info">
                            <div class="member-name">User ${index + 1}</div>
                            <div class="member-date">Joined: ${new Date(member.joinedAt).toLocaleDateString()}</div>
                        </div>
                        <div class="member-earnings">৳ ${member.earnings ? member.earnings.toFixed(2) : '0.00'}</div>
                    `;
                    teamMembersList.appendChild(memberElement);
                });
            } else {
                teamMembersList.innerHTML = '<p style="text-align: center; color: #888;">No team members yet</p>';
            }
            
            // Control withdrawal button visibility based on session type
            const withdrawBtn = document.getElementById('open-withdraw-modal-profile');
            if (isSharedSession) {
                // In shared session, hide withdrawal button
                if (withdrawBtn) {
                    withdrawBtn.style.display = 'none';
                }
            } else {
                // In normal session, show withdrawal button
                if (withdrawBtn) {
                    withdrawBtn.style.display = 'block';
                }
            }
        }
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    if (pageId) {
                        // Remove active class from all nav items
                        document.querySelectorAll('.nav-item').forEach(nav => {
                            nav.classList.remove('active');
                        });
                        // Add active class to clicked nav item
                        this.classList.add('active');
                        // Hide all pages
                        document.querySelectorAll('.page').forEach(page => {
                            page.classList.remove('active');
                        });
                        // Show the selected page
                        document.getElementById(pageId).classList.add('active');
                        // Hide the small back button when switching pages
                        document.getElementById('back-to-home-top').style.display = 'none';
                    }
                });
            });
            
            // Watch Ads button
            document.getElementById('ad-button').addEventListener('click', function() {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                // Show ads page
                document.getElementById('ads-page').classList.add('active');
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector('[data-page="ads-page"]').classList.add('active');
                // Show the small back button
                document.getElementById('back-to-home-top').style.display = 'block';
            });
            
            // Back to home buttons (both small and regular)
            document.getElementById('back-to-home-top').addEventListener('click', function() {
                goBackToHome();
            });
            
            // Watch Ad button (calls Monetag function directly)
            document.getElementById('watch-ad-btn').addEventListener('click', function() {
                watchAdDirectly();
            });
            
            // Team button
            document.getElementById('team-button').addEventListener('click', function() {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                // Show team page
                document.getElementById('team-page').classList.add('active');
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector('[data-page="team-page"]').classList.add('active');
            });
            
            // Open withdrawal modal (only from profile page now)
            document.getElementById('open-withdraw-modal-profile').addEventListener('click', function() {
                // Only allow withdrawal if it's not a shared session
                if (isSharedSession) {
                    alert('You cannot withdraw from a shared session.');
                    return;
                }
                openWithdrawalModal();
            });
            
            // Close modal
            document.getElementById('close-modal').addEventListener('click', closeWithdrawalModal);
            
            // Method selection
            document.querySelectorAll('.withdrawal-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectMethod(this);
                });
            });
            
            // Form validation
            document.getElementById('phone-number').addEventListener('input', validateForm);
            document.getElementById('amount').addEventListener('input', validateForm);
            
            // Submit withdrawal
            document.getElementById('submit-withdrawal').addEventListener('click', submitWithdrawal);
            
            // Copy referral link
            document.getElementById('copy-btn').addEventListener('click', function() {
                const referralInput = document.getElementById('referral-input');
                referralInput.select();
                document.execCommand('copy');
                alert('Referral link copied to clipboard!');
            });
            
            // Copy invite link
            document.getElementById('copy-invite-btn').addEventListener('click', function() {
                const inviteLinkElement = document.getElementById('invite-link');
                const tempInput = document.createElement('input');
                tempInput.value = inviteLinkElement.textContent;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('Invite link copied to clipboard!');
            });
        }
        
        // Function to go back to home page
        function goBackToHome() {
            // Hide ads page
            document.getElementById('ads-page').classList.remove('active');
            // Show home page
            document.getElementById('home-page').classList.add('active');
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            document.querySelector('[data-page="home-page"]').classList.add('active');
            // Hide the small back button
            document.getElementById('back-to-home-top').style.display = 'none';
        }
        
        // Function to watch ad directly using Monetag's method
        function watchAdDirectly() {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            // Prevent multiple clicks while ad is running
            if (isAdRunning) {
                console.log("An ad is already running.");
                return;
            }
            isAdRunning = true;
            watchAdBtn.disabled = true;
            watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Ad...';
            
            // IMPORTANT: Use your new zone ID function name
            const monetagFunctionName = 'show_9753772'; // Match data-sdk attribute
            const monetagFunction = window[monetagFunctionName]; // Access function dynamically
            console.log("Attempting to show ad with function:", monetagFunctionName);
            
            // Check if monetag function is available
            if (typeof monetagFunction === 'function') {
                try {
                    console.log(`Showing ad directly with Monetag SDK function: ${monetagFunctionName}`);
                    // Call the Monetag function directly to open ad
                    monetagFunction();
                    console.log("Monetag function called successfully.");
                    
                    // Since we can't reliably detect when the ad is finished,
                    // we reward the user after a short delay and re-enable the button.
                    // This allows the user to click again quickly.
                    setTimeout(() => {
                        console.log("Rewarding user and re-enabling button.");
                        rewardUserForAd();
                        resetAdButton(); // Re-enable button immediately
                    }, 2000); // 2 second delay before rewarding and re-enabling
                } catch (error) {
                    console.error("Error showing ad:", error);
                    document.getElementById('ad-network-container').innerHTML = '<div class="ad-error"><p>Error loading advertisements. Please try again later.</p></div>';
                    resetAdButton();
                }
            } else {
                console.log(`Monetag SDK function '${monetagFunctionName}' not available yet.`);
                document.getElementById('ad-network-container').innerHTML = '<div class="ad-error"><p>Ad script is still loading. Please try again in a few seconds.</p></div>';
                // Retry after a delay or re-enable button
                setTimeout(() => {
                     resetAdButton();
                }, 3000);
            }
        }
        
        // Reset the ad button state
        function resetAdButton() {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            isAdRunning = false;
            watchAdBtn.disabled = false;
            watchAdBtn.innerHTML = '<i class="fas fa-play-circle"></i> Watch Ad & Earn 50 Coins';
            console.log("Ad button reset.");
        }
        
        function rewardUserForAd() {
            if (!currentUser) return;
            
            // Determine which user reference to use (original or current)
            const targetUserRef = isSharedSession ? originalUserRef : userRef;
            if (!targetUserRef) {
                console.error("No valid user reference for rewarding.");
                return;
            }
            
            // Update user data in Firebase
            targetUserRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const newCoins = (data.coins || 0) + COINS_PER_AD;
                    // আপনার নির্দেশ অনুযায়ী: এড দেখলে শুধুমাত্র কয়েন বাড়বে, ব্যালেন্স বাড়বে না
                    // const newBalance = (data.balance || 0) + (COINS_PER_AD * 0.01); // Convert coins to balance (example: 50 coins = 0.50 BDT)
                    const newBalance = data.balance || 0; // ব্যালেন্স পরিবর্তন হবে না
                    
                    // If it's a shared session, calculate 10% commission for the original user
                    let updates = {
                        coins: newCoins,
                        balance: newBalance // ব্যালেন্স পরিবর্তন হবে না
                    };
                    
                    if (isSharedSession) {
                        // In shared session, 10% goes to original user
                        // যেহেতু ব্যালেন্স এখন পরিবর্তিত হচ্ছে না, কমিশনও দেওয়া হবে না
                        // const commission = (COINS_PER_AD * 0.01) * 0.10; // 10% of balance increase
                        // const originalNewBalance = (data.balance || 0) + commission;
                        // Add commission to original user's earnings from team
                        // const originalTotalEarningsFromTeam = (data.totalEarningsFromTeam || 0) + commission;
                        // updates.balance = originalNewBalance;
                        // updates.totalEarningsFromTeam = originalTotalEarningsFromTeam;
                        console.log(`Awarding ${COINS_PER_AD} coins to shared account. No commission as balance is not updated yet.`);
                    } else {
                        console.log(`Awarding ${COINS_PER_AD} coins to user's own account. Balance remains unchanged until midnight conversion.`);
                    }
                    
                    return targetUserRef.update(updates);
                }
            }).then(() => {
                // Update UI
                // We need to get the current displayed values and add to them
                const currentCoins = parseInt(document.getElementById('coin-amount').textContent) || 0;
                // const currentBalance = parseFloat(document.getElementById('balance-amount').textContent) || 0;
                document.getElementById('coin-amount').textContent = currentCoins + COINS_PER_AD;
                // document.getElementById('balance-amount').textContent = 
                //     ((currentBalance + (COINS_PER_AD * 0.01))).toFixed(2);
                
                // Show reward notification
                showRewardNotification();
            }).catch(error => {
                console.error("Error rewarding user:", error);
            });
        }
        
        function showRewardNotification() {
            const notification = document.getElementById('reward-notification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function openWithdrawalModal() {
            // Additional check for shared session
            if (isSharedSession) {
                alert('You cannot withdraw from a shared session.');
                return;
            }
            document.getElementById('withdraw-modal').style.display = 'flex';
            resetForm();
        }
        
        function closeWithdrawalModal() {
            document.getElementById('withdraw-modal').style.display = 'none';
        }
        
        function selectMethod(element) {
            // Remove selected class from all options
            document.querySelectorAll('.withdrawal-option').forEach(option => {
                option.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Store selected method
            selectedMethod = element.getAttribute('data-method');
            validateForm();
        }
        
        function validateForm() {
            const phoneNumber = document.getElementById('phone-number').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const submitButton = document.getElementById('submit-withdrawal');
            
            if (selectedMethod && phoneNumber.length >= 10 && amount >= 100) {
                // Check balance from Firebase (use appropriate reference)
                const targetUserRef = isSharedSession ? originalUserRef : userRef;
                if (targetUserRef) {
                    targetUserRef.once('value').then(snapshot => {
                        const data = snapshot.val();
                        if (data && amount <= data.balance) {
                            submitButton.disabled = false;
                        } else {
                            submitButton.disabled = true;
                        }
                    });
                } else {
                    submitButton.disabled = true;
                }
            } else {
                submitButton.disabled = true;
            }
        }
        
        function resetForm() {
            selectedMethod = null;
            document.getElementById('phone-number').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('submit-withdrawal').disabled = true;
            // Deselect all methods
            document.querySelectorAll('.withdrawal-option').forEach(option => {
                option.classList.remove('selected');
            });
        }
        
        function submitWithdrawal() {
            // Prevent withdrawal in shared sessions
            if (isSharedSession) {
                alert('You cannot withdraw from a shared session.');
                return;
            }
            
            if (!currentUser || !userRef) {
                alert('User not authenticated!');
                return;
            }
            
            const phoneNumber = document.getElementById('phone-number').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            if (!selectedMethod || phoneNumber.length < 10 || isNaN(amount) || amount < 100) {
                alert('Please fill all fields correctly!');
                return;
            }
            
            // Check balance
            userRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (!data || amount > data.balance) {
                    alert('Insufficient balance!');
                    return;
                }
                
                // Create withdrawal request object
                const withdrawalRequest = {
                    method: selectedMethod,
                    phone: phoneNumber,
                    amount: amount,
                    date: new Date().toISOString(),
                    status: 'pending',
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'User'
                };
                
                // Save to Firebase
                const newRequestRef = database.ref('withdrawal_requests').push();
                return newRequestRef.set(withdrawalRequest)
                    .then(() => {
                        // Update user balance
                        const newBalance = data.balance - amount;
                        return userRef.update({
                            balance: newBalance
                        });
                    });
            })
            .then(() => {
                // Close modal and show success message
                closeWithdrawalModal();
                alert('Withdrawal request submitted successfully! It will be processed within 24 hours.');
                // Update UI balance immediately
                document.getElementById('balance-amount').textContent = 
                    (parseFloat(document.getElementById('balance-amount').textContent) - amount).toFixed(2);
            })
            .catch(error => {
                console.error('Error saving withdrawal request: ', error);
                alert('Error submitting withdrawal request. Please try again.');
            });
        }
        
        function loadWithdrawalHistory() {
            const historyContainer = document.getElementById('withdrawal-history');
            historyContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">Loading...</p>';
            
            if (!currentUser) {
                historyContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">Please login to view history</p>';
                return;
            }
            
            const withdrawalsRef = database.ref('withdrawal_requests');
            withdrawalsRef.orderByChild('userId').equalTo(currentUser.uid).once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    historyContainer.innerHTML = '';
                    
                    if (!data) {
                        historyContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">No withdrawal history</p>';
                        return;
                    }
                    
                    // Convert to array and sort by date
                    const withdrawals = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    })).sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    if (withdrawals.length === 0) {
                        historyContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">No withdrawal history</p>';
                        return;
                    }
                    
                    withdrawals.forEach(withdrawal => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        
                        // Determine status badge
                        let statusBadge = '';
                        if (withdrawal.status === 'pending') {
                            statusBadge = '<span class="status-badge status-pending">Pending</span>';
                        } else if (withdrawal.status === 'processing') {
                            statusBadge = '<span class="status-badge status-processing">Processing</span>';
                        } else if (withdrawal.status === 'success') {
                            statusBadge = '<span class="status-badge status-success">Success</span>';
                        } else if (withdrawal.status === 'rejected') {
                            statusBadge = '<span class="status-badge status-rejected">Rejected</span>';
                        }
                        
                        // Determine method icon
                        let methodIcon = '';
                        if (withdrawal.method === 'bkash') {
                            methodIcon = '<i class="fas fa-mobile-alt" style="color: #e2136e;"></i>';
                        } else if (withdrawal.method === 'nagad') {
                            methodIcon = '<i class="fas fa-university" style="color: #f8a61c;"></i>';
                        } else if (withdrawal.method === 'rocket') {
                            methodIcon = '<i class="fas fa-rocket" style="color: #5d2d8d;"></i>';
                        }
                        
                        historyItem.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <div style="font-size: 24px; margin-right: 10px;">
                                    ${methodIcon}
                                </div>
                                <div>
                                    <div>Withdrawal to ${withdrawal.method}</div>
                                    <div class="history-date">${new Date(withdrawal.date).toLocaleDateString()} ${statusBadge}</div>
                                </div>
                            </div>
                            <div class="history-amount" style="color: ${withdrawal.status === 'success' ? '#4caf50' : '#ff9800'};">৳ ${withdrawal.amount.toFixed(2)}</div>
                        `;
                        historyContainer.appendChild(historyItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading withdrawal history: ', error);
                    historyContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: #888;">Error loading history</p>';
                });
        }
        
        // Listen for status updates from admin in Firebase
        function listenForWithdrawalUpdates() {
            if (!currentUser) return;
            
            const withdrawalsRef = database.ref('withdrawal_requests');
            withdrawalsRef.orderByChild('userId').equalTo(currentUser.uid).on('value', (snapshot) => {
                // Update UI if history page is active
                if (document.getElementById('history-page').classList.contains('active')) {
                    loadWithdrawalHistory();
                }
            });
        }
        
        // Load history when history page becomes active
        document.querySelector('[data-page="history-page"]').addEventListener('click', function() {
            setTimeout(loadWithdrawalHistory, 100);
        });
        
        // Function to convert coins to BDT at midnight (Bangladesh Time)
        // আপনার নির্দেশ অনুযায়ী কয়েন রূপান্তর লজিক সংশোধন করা হয়েছে
        function convertCoinsToBDT() {
            if (!currentUser || !userRef) return;
            
            // Use appropriate reference for conversion
            const targetUserRef = isSharedSession ? originalUserRef : userRef;
            if (!targetUserRef) {
                console.error("No valid user reference for conversion.");
                return;
            }
            
            targetUserRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const coins = data.coins || 0;
                    const currentBalance = data.balance || 0;
                    
                    // আপনার নির্দেশ অনুযায়ী: প্রতি 1000 কয়েন = 1 টাকা, ভগ্নাংশের জন্যও প্রযোজ্য
                    // এখানে আমরা সরাসরি ভাগ করে টাকা বের করছি
                    const bdtToAdd = coins / COINS_TO_BDT_RATE; // 1000
                    
                    // আপনার নির্দেশ অনুযায়ী: যে কোন পরিমাণ কয়েন (এমনকি 50 কয়েনও) রূপান্তর হবে
                    if (bdtToAdd > 0) { // শুধুমাত্র কয়েন 0 এর বেশি হলে রূপান্তর হবে
                        const newBalance = currentBalance + bdtToAdd;
                        const remainingCoins = 0; // সব কয়েন রূপান্তর হয়ে গেছে
                        
                        // Update user data
                        return targetUserRef.update({
                            balance: parseFloat(newBalance.toFixed(2)), // Ensure precision
                            coins: remainingCoins,
                            lastConversionDate: new Date().toISOString().split('T')[0]
                        }).then(() => {
                            // Update UI
                            document.getElementById('balance-amount').textContent = parseFloat(newBalance.toFixed(2));
                            document.getElementById('coin-amount').textContent = remainingCoins;
                            
                            console.log(`Converted ${coins} coins to ৳${bdtToAdd.toFixed(2)}. New balance: ৳${newBalance.toFixed(2)}. Coins reset to 0.`);
                        });
                    } else {
                        console.log(`Not enough coins (${coins}) to convert. Minimum required is 1 coin (৳0.001).`);
                    }
                }
            }).catch(error => {
                console.error("Error converting coins to BDT:", error);
            });
        }

        // Start timer to check for daily conversion at midnight Bangladesh time
        // আপনার নির্দেশ অনুযায়ী সময় নির্ধারণ করা হয়েছে: রাত 12:00 (বাংলাদেশ সময়)
        function startDailyConversionTimer() {
            // Get current time in Bangladesh timezone
            const bangladeshTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Dhaka"});
            const bangladeshDate = new Date(bangladeshTime);
            
            // Calculate time until next midnight in Bangladesh
            const tomorrow = new Date(bangladeshDate);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0); // Set to 12:00 AM (Bangladesh Time)
            
            const timeUntilMidnight = tomorrow.getTime() - bangladeshDate.getTime();
            
            console.log(`Next coin conversion scheduled for 12:00 AM Bangladesh Time, which is in ${Math.floor(timeUntilMidnight / (1000 * 60))} minutes`);
            
            // Set timeout for first conversion
            setTimeout(() => {
                console.log("Starting automatic coin conversion at 12:00 AM (Bangladesh Time).");
                convertCoinsToBDT();
                // Set interval for daily conversions (every 24 hours)
                setInterval(convertCoinsToBDT, 24 * 60 * 60 * 1000);
                console.log("Daily coin conversion timer set to run every 24 hours at 12:00 AM.");
            }, timeUntilMidnight);
        }
    </script>
</body>
</html>
