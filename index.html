<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TKBD5 Earning App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="module" defer>
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD3BGZ0MVLpbQbIpLUAnYvWNEIyk7Y6S0Q",
            authDomain: "earning-app-80258.firebaseapp.com",
            databaseURL: "https://earning-app-80258-default-rtdb.firebaseio.com",
            projectId: "earning-app-80258",
            storageBucket: "earning-app-80258.appspot.com",
            messagingSenderId: "25930019210",
            appId: "1:25930019210:web:6441562811d3e7e9631873",
            measurementId: "G-P9HX6XXT1Q"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        // Global variables
        let userId = null;
        let userData = null;
        let isBlocked = false;
        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is blocked
            await checkUserBlockStatus();
            if (!isBlocked) {
                // Get Telegram user data
                userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
                if (!userId) {
                    alert("Telegram ইউজার আইডি পাওয়া যায়নি। অনুগ্রহ পূর্বক অ্যাপটি টেলিগ্রামের মাধ্যমে খুলুন।");
                    return;
                }
                // Load user data
                await loadUserData();
                // Setup event listeners
                setupEventListeners();
                // Show homepage by default
                showPage('home');
            }
        });
        // Check if user is blocked
        async function checkUserBlockStatus() {
            userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : null;
            if (!userId) return;
            const userRef = ref(db, 'users/' + userId);
            const snapshot = await get(userRef);
            if (snapshot.exists() && snapshot.val().blocked) {
                isBlocked = true;
                document.getElementById('block-page').style.display = 'flex';
            }
        }
        // Load user data from Firebase
        async function loadUserData() {
            const userRef = ref(db, 'users/' + userId);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                userData = snapshot.val();
                updateUIWithUserData();
            } else {
                // New user, create account
                userData = {
                    userId: userId,
                    balance: 0,
                    totalEarned: 0,
                    referrals: 0,
                    referralCode: generateReferralCode(userId),
                    joinedDate: new Date().toISOString(),
                    blocked: false
                };
                // Check for referral
                const startParam = tg.initDataUnsafe.start_param;
                if (startParam && startParam.startsWith('ref_')) {
                    const referrerId = startParam.substring(4);
                    await handleReferral(referrerId);
                }
                // Save new user
                await set(userRef, userData);
            }
            // Update UI
            updateUIWithUserData();
        }
        // Handle referral
        async function handleReferral(referrerId) {
            const referrerRef = ref(db, 'users/' + referrerId);
            const referrerSnapshot = await get(referrerRef);
            if (referrerSnapshot.exists()) {
                const referrerData = referrerSnapshot.val();
                // Update referrer's data
                const newReferrals = (referrerData.referrals || 0) + 1;
                const newBalance = (referrerData.balance || 0) + 10; // 10 taka bonus
                await update(referrerRef, {
                    referrals: newReferrals,
                    balance: newBalance,
                    totalEarned: (referrerData.totalEarned || 0) + 10
                });
                // Update current user's referral data
                userData.referrerId = referrerId;
                userData.referralLevel = 1; // Direct referral
            }
        }
        // Generate referral code
        function generateReferralCode(userId) {
            // Create a unique referral code based on user ID
            return `TKBD${userId.toString().slice(-6)}`;
        }
        // Update UI with user data
        function updateUIWithUserData() {
            // Update profile picture
            if (tg.initDataUnsafe.user && tg.initDataUnsafe.user.photo_url) {
                document.getElementById('profile-pic').src = tg.initDataUnsafe.user.photo_url;
            }
            // Update user info
            if (tg.initDataUnsafe.user) {
                document.getElementById('user-name').textContent = 
                    tg.initDataUnsafe.user.first_name + (tg.initDataUnsafe.user.last_name ? ' ' + tg.initDataUnsafe.user.last_name : '');
                document.getElementById('user-id').textContent = `@${tg.initDataUnsafe.user.username || 'ID: ' + userId}`;
            }
            // Update balance
            document.getElementById('balance-amount').textContent = userData.balance.toFixed(2);
            // Update referrals
            document.getElementById('referral-count').textContent = userData.referrals || 0;
            // Update referral code
            const referralCode = userData.referralCode || generateReferralCode(userId);
            document.getElementById('referral-code').textContent = referralCode;
            document.getElementById('referral-link').value = `https://t.me/TKBD5_bot?start=ref_${userId}`;
        }
        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.getAttribute('data-page');
                    showPage(page);
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                });
            });
            // Tab to Earn button
            document.getElementById('tab-to-earn').addEventListener('click', () => {
                showAd();
            });
            // Withdraw button
            document.getElementById('withdraw-btn').addEventListener('click', () => {
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const method = document.querySelector('input[name="withdraw-method"]:checked')?.value;
                if (!method) {
                    alert('অনুগ্রহ পূর্বক উইথড্র মাধ্যম নির্বাচন করুন');
                    return;
                }
                if (amount < 200) {
                    alert('ন্যূনতম উইথড্র পরিমাণ ২০০ টাকা');
                    return;
                }
                if (amount > userData.balance) {
                    alert('আপনার ব্যালেন্স অপর্যাপ্ত');
                    return;
                }
                processWithdrawal(amount, method);
            });
            // Copy referral link
            document.getElementById('copy-referral').addEventListener('click', () => {
                const referralLink = document.getElementById('referral-link');
                referralLink.select();
                document.execCommand('copy');
                alert('রেফারেল লিঙ্ক কপি করা হয়েছে!');
            });
            // Contact admin from block page
            document.getElementById('contact-admin').addEventListener('click', () => {
                tg.openTelegramLink('https://t.me/Nikhil_Shaan');
            });
        }
        // Show specific page
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            // Show selected page
            document.getElementById(pageId + '-page').style.display = 'block';
            // Special handling for pages
            if (pageId === 'history') {
                loadWithdrawalHistory();
            } else if (pageId === 'refer') {
                updateReferralStats();
            }
        }
        // Show ad and reward user
        function showAd() {
            // Show the ad container
            document.getElementById('ad-container').style.display = 'block';
            // Initialize Monetag ad
            const adScript = document.createElement('script');
            adScript.src = '//libtl.com/sdk.js';
            adScript.setAttribute('data-zone', '9807992');
            adScript.setAttribute('data-sdk', 'show_9807992');
            document.head.appendChild(adScript);
            // Add event listener for ad completion
            window.addEventListener('monetagAdClosed', async () => {
                // Reward user 5 poysha (0.05 taka)
                const reward = 0.05;
                userData.balance = (userData.balance || 0) + reward;
                userData.totalEarned = (userData.totalEarned || 0) + reward;
                // Update Firebase
                const userRef = ref(db, 'users/' + userId);
                await update(userRef, {
                    balance: userData.balance,
                    totalEarned: userData.totalEarned
                });
                // Update UI
                updateUIWithUserData();
                // Hide ad container
                document.getElementById('ad-container').style.display = 'none';
                alert(`আপনি ${reward} টাকা আয় করেছেন!`);
            });
        }
        // Process withdrawal
        async function processWithdrawal(amount, method) {
            const withdrawalId = 'WID_' + Date.now();
            const withdrawalData = {
                id: withdrawalId,
                amount: amount,
                method: method,
                status: 'pending',
                timestamp: new Date().toISOString(),
                userId: userId
            };
            // Save to Firebase
            const withdrawalRef = ref(db, 'withdrawals/' + withdrawalId);
            await set(withdrawalRef, withdrawalData);
            // Update user balance
            userData.balance -= amount;
            const userRef = ref(db, 'users/' + userId);
            await update(userRef, {
                balance: userData.balance
            });
            // Update UI
            updateUIWithUserData();
            showPage('history');
            alert('উইথড্র রিকোয়েস্ট সাবমিট করা হয়েছে!');
        }
        // Load withdrawal history
        async function loadWithdrawalHistory() {
            const historyList = document.getElementById('withdrawal-history');
            historyList.innerHTML = '<div class="loading">লোড হচ্ছে...</div>';
            const withdrawalsRef = ref(db, 'withdrawals');
            const snapshot = await get(child(withdrawalsRef, `?orderByChild=userId&equalTo=${userId}`));
            historyList.innerHTML = '';
            if (snapshot.exists()) {
                const withdrawals = snapshot.val();
                let hasHistory = false;
                for (const id in withdrawals) {
                    if (withdrawals[id].userId === userId) {
                        hasHistory = true;
                        const withdrawal = withdrawals[id];
                        const statusClass = withdrawal.status === 'approved' ? 'status-success' : 
                                          withdrawal.status === 'rejected' ? 'status-rejected' : 'status-pending';
                        const historyItem = document.createElement('div');
                        historyItem.className = 'history-item';
                        historyItem.innerHTML = `
                            <div class="history-header">
                                <span class="amount">${withdrawal.amount} টাকা</span>
                                <span class="status ${statusClass}">${getStatusText(withdrawal.status)}</span>
                            </div>
                            <div class="history-details">
                                <p><strong>মাধ্যম:</strong> ${getPaymentMethodText(withdrawal.method)}</p>
                                <p><strong>তারিখ:</strong> ${formatDate(withdrawal.timestamp)}</p>
                                ${withdrawal.status === 'rejected' ? `<p><strong>কারণ:</strong> ${withdrawal.rejectionReason || 'অজানা'}</p>` : ''}
                            </div>
                        `;
                        historyList.appendChild(historyItem);
                    }
                }
                if (!hasHistory) {
                    historyList.innerHTML = '<div class="no-history">কোন উইথড্র ইতিহাস নেই</div>';
                }
            } else {
                historyList.innerHTML = '<div class="no-history">কোন উইথড্র ইতিহাস নেই</div>';
            }
        }
        // Update referral stats
        async function updateReferralStats() {
            // Update referral count
            document.getElementById('referral-count').textContent = userData.referrals || 0;
            // Load referral history
            const referralsList = document.getElementById('referrals-list');
            referralsList.innerHTML = '<div class="loading">লোড হচ্ছে...</div>';
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            referralsList.innerHTML = '';
            if (snapshot.exists()) {
                const users = snapshot.val();
                let referralCount = 0;
                for (const id in users) {
                    if (users[id].referrerId === userId) {
                        referralCount++;
                        const referralUser = users[id];
                        const referralItem = document.createElement('div');
                        referralItem.className = 'referral-item';
                        referralItem.innerHTML = `
                            <div class="referral-user">
                                <div class="referral-id">ইউজার আইডি: ${id}</div>
                                <div class="referral-earned">আয়: ১০ টাকা</div>
                            </div>
                            <div class="referral-date">যোগদান: ${formatDate(referralUser.joinedDate)}</div>
                        `;
                        referralsList.appendChild(referralItem);
                    }
                }
                if (referralCount === 0) {
                    referralsList.innerHTML = '<div class="no-referrals">কোন রেফারেল নেই</div>';
                }
            } else {
                referralsList.innerHTML = '<div class="no-referrals">কোন রেফারেল নেই</div>';
            }
        }
        // Helper functions
        function getStatusText(status) {
            const statusMap = {
                'pending': 'প্রসেসিং',
                'approved': 'সফল',
                'rejected': 'বাতিল'
            };
            return statusMap[status] || status;
        }
        function getPaymentMethodText(method) {
            const methodMap = {
                'nagad': 'নগদ',
                'bkash': 'বিকাশ',
                'rocket': 'রকেট'
            };
            return methodMap[method] || method;
        }
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('bn-BD', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            font-size: 16px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 70px;
        }
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        /* User Profile */
        .user-profile {
            background-color: white;
            border-radius: 20px;
            margin: -40px 20px 20px;
            padding: 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
            z-index: 10;
        }
        .profile-pic {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #6a11cb;
            background-color: #f0f0f0;
        }
        .user-info {
            margin-left: 15px;
            flex: 1;
        }
        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .user-id {
            font-size: 14px;
            color: #666;
        }
        .balance-card {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            color: white;
        }
        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .balance-amount {
            font-size: 28px;
            font-weight: 700;
            margin: 5px 0;
        }
        .balance-footer {
            font-size: 12px;
            opacity: 0.8;
        }
        /* Main Content */
        .main-content {
            padding: 0 20px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 20px 0 15px;
            color: #444;
        }
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        .action-btn {
            flex: 1;
            background-color: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .action-btn:active {
            transform: translateY(2px);
        }
        .action-btn-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
        }
        .action-btn-icon i {
            font-size: 24px;
            color: white;
        }
        .action-btn-text {
            font-weight: 600;
            font-size: 16px;
        }
        .action-btn-subtext {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        /* Withdrawal Section */
        .withdraw-section {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        .withdraw-input {
            display: flex;
            align-items: center;
            background-color: #f8f8f8;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
        }
        .withdraw-input input {
            flex: 1;
            border: none;
            background: none;
            font-size: 18px;
            padding: 5px;
            outline: none;
        }
        .withdraw-input span {
            font-weight: 600;
            color: #6a11cb;
        }
        .payment-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .payment-method {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 12px 5px;
            text-align: center;
            transition: all 0.2s;
        }
        .payment-method input {
            display: none;
        }
        .payment-method img {
            height: 24px;
            margin: 0 auto 8px;
        }
        .payment-method label {
            font-size: 12px;
            display: block;
        }
        .payment-method input:checked + img {
            border: 2px solid #6a11cb;
            border-radius: 8px;
            padding: 2px;
        }
        .withdraw-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .withdraw-btn:active {
            opacity: 0.9;
        }
        /* History Section */
        .history-item {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .amount {
            font-weight: 600;
            font-size: 16px;
        }
        .status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .status-pending {
            background-color: #fff9db;
            color: #8a6d3b;
        }
        .status-success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .status-rejected {
            background-color: #f2dede;
            color: #a94442;
        }
        .history-details {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        /* Referral Section */
        .referral-card {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border-radius: 15px;
            padding: 15px;
            color: white;
            margin-bottom: 20px;
        }
        .referral-stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        .referral-link {
            background-color: white;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
        }
        .referral-link input {
            flex: 1;
            border: none;
            background: none;
            padding: 5px;
            font-size: 14px;
            outline: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .copy-btn {
            background-color: #6a11cb;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
        }
        .referral-list {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .referral-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .referral-item:last-child {
            border-bottom: none;
        }
        .referral-user {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .referral-id {
            font-weight: 500;
            font-size: 14px;
        }
        .referral-earned {
            color: #6a11cb;
            font-weight: 600;
        }
        .referral-date {
            font-size: 12px;
            color: #888;
        }
        /* Navigation */
        .nav-bar {
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid #eee;
            position: absolute;
            bottom: 0;
            width: 100%;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #888;
            font-size: 12px;
            transition: color 0.2s;
        }
        .nav-item.active {
            color: #6a11cb;
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        /* Ad Container */
        #ad-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .ad-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
        }
        /* Block Page */
        #block-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }
        .block-icon {
            font-size: 60px;
            color: #ff4444;
            margin-bottom: 20px;
        }
        .block-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }
        .block-message {
            font-size: 16px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        .contact-admin-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        /* Common Styles */
        .page {
            display: none;
            height: 100%;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .no-history, .no-referrals {
            text-align: center;
            padding: 20px;
            color: #888;
            font-style: italic;
        }
        /* Icons using Unicode characters as fallback */
        .icon-home::before { content: "🏠"; }
        .icon-withdraw::before { content: "💰"; }
        .icon-history::before { content: "📜"; }
        .icon-refer::before { content: "👥"; }
        .icon-profile::before { content: "👤"; }
        .icon-earn::before { content: "🎯"; }
        .icon-close::before { content: "×"; }
    </style>
</head>
<body>
    <!-- Block Page (Visible only when user is blocked) -->
    <div id="block-page">
        <div class="block-icon">🚫</div>
        <h2 class="block-title">অ্যাকাউন্ট ব্লক করা হয়েছে</h2>
        <p class="block-message">আপনার অ্যাকাউন্ট অসামঞ্জস্যপূর্ণ কার্যকলাপের কারণে ব্লক করা হয়েছে। অনুগ্রহ করে এডমিনের সাথে যোগাযোগ করুন।</p>
        <button id="contact-admin" class="contact-admin-btn">এডমিনের সাথে যোগাযোগ করুন</button>
    </div>
    <div class="container">
        <!-- Home Page -->
        <div id="home-page" class="page">
            <div class="header">
                <h1>TKBD5 Earning App
