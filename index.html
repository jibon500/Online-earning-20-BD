```htmlধঠদফদফ্যফফধফরফধফরফ্য
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earning App</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #0088cc; /* Telegram Blue */
            --secondary-color: #dddddd; /* Light Gray */
            --background-color: #ffffff; /* White */
            --text-color: #000000; /* Black */
            --success-color: #28a745; /* Bootstrap Success */
            --warning-color: #ffc107; /* Bootstrap Warning */
            --danger-color: #dc3545; /* Bootstrap Danger */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        .container {
            padding: 15px;
            max-width: 100%;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space between items */
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        #profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 10px;
        }
        #profile-pic img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        #user-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #username {
            font-size: 18px;
            font-weight: bold;
        }
        #points-display, #balance-display {
            font-size: 16px;
            color: #666;
        }
        .nav-tabs {
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .nav-tabs .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: .375rem;
            border-top-right-radius: .375rem;
            color: #495057;
            padding: 8px 12px; /* Reduced padding */
            font-size: 14px; /* Reduced font size */
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--background-color);
            border-color: #dee2e6 #dee2e6 var(--background-color);
            border-bottom: 2px solid var(--primary-color); /* Active indicator */
        }
        .tab-content {
            min-height: calc(100vh - 200px); /* Adjust based on header/tabs height */
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            background-color: var(--background-color);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: bold;
            padding: 10px 15px;
        }
        .card-body {
            padding: 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: #f1f3f4;
            border-radius: 6px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        .ad-section {
            margin-bottom: 20px;
        }
        .ad-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .ad-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            background-color: white;
        }
        .ad-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .ad-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        .ad-content {
            padding: 10px;
        }
        .ad-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .ad-reward {
            font-size: 16px;
            color: var(--success-color);
            font-weight: bold;
        }
        .ad-button {
            display: block;
            width: 100%;
            padding: 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            margin-top: 8px;
            text-decoration: none;
        }
        .ad-button:hover:not(:disabled) {
            background-color: #0077b3; /* Slightly darker on hover */
        }
        .ad-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .ad-button.requesting {
             background-color: #6c757d; /* Bootstrap secondary */
        }
        .withdraw-section {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0077b3;
        }
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        .btn-warning {
            background-color: var(--warning-color);
            color: black;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 3px;
        }
        .history-detail {
            font-size: 14px;
        }
        .referral-code {
            font-weight: bold;
            color: var(--primary-color);
            word-break: break-all;
        }
        .copy-btn {
            background-color: var(--secondary-color);
            color: black;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .copy-btn:hover {
            background-color: #cccccc;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: var(--background-color);
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close:hover,
        .close:focus {
            color: black;
        }
        .notice-item {
             padding: 10px;
             border-bottom: 1px solid #e0e0e0;
             background-color: #fff8e1; /* Light yellow for notices */
        }
        .notice-item:last-child {
             border-bottom: none;
        }
        .notice-title {
             font-weight: bold;
             margin-bottom: 5px;
             color: #e65100; /* Deep orange for notice title */
        }
        .notice-message {
             font-size: 14px;
        }
        .notice-date {
             font-size: 12px;
             color: #999;
             margin-top: 5px;
        }
        .blocked-view-content {
            text-align: center;
            padding: 40px 20px;
        }
        .blocked-icon {
            font-size: 48px;
            color: var(--danger-color);
            margin-bottom: 20px;
        }
        .blocked-message {
            font-size: 18px;
            margin-bottom: 20px;
        }
        .support-link {
            color: var(--primary-color);
            text-decoration: none;
        }
        .support-link:hover {
            text-decoration: underline;
        }
        .message-bubble {
            padding: 12px 18px; /* Increased padding */
            border-radius: 20px; /* Increased border-radius */
            margin-bottom: 12px; /* Increased margin */
            max-width: 85%; /* Slightly increased max-width */
            word-wrap: break-word;
            font-size: 15px; /* Increased font size */
            /* - Update: Removed default margin alignment - */
            /* margin-left: auto; */
            /* margin-right: auto; */
            /* - End Update - */
        }
        .user-message {
            background-color: var(--primary-color);
            color: #000;
            /* - Update: Float right for user messages - */
            margin-left: auto; /* ডানে সারিবদ্ধ */
            /* - End Update - */
        }
        .admin-message {
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin-right: auto; /* বামে সারিবদ্ধ */
        }
        #message-history {
            max-height: 60vh; /* Increased max-height for message history */
            min-height: 300px; /* Ensure a minimum height */
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bs-body-bg); /* Use Bootstrap's body background */
            border-radius: 8px;
            border: 1px solid var(--bs-border-color); /* Use Bootstrap's border color */
            display: flex; /* ফ্লেক্সবক্স লেআউট */
            flex-direction: column; /* কলাম অর্ডার */
        }
        #message-input-container {
            display: flex;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
        }
        .footer {
            text-align: center;
            padding: 15px 0;
            font-size: 12px;
            color: #999;
            border-top: 1px solid #e0e0e0;
            margin-top: 20px;
        }
        /* --- Update: Add styles for the real-time data indicator --- */
        #realtime-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #28a745; /* Green */
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999; /* High z-index to stay on top */
        }
        #realtime-indicator.updating {
            opacity: 1;
        }
        /* --- End Update --- */
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        /* --- Update: Styles for the dynamic reset timer display --- */
        #reset-timer-display {
            font-weight: bold;
            color: var(--primary-color);
        }
        /* --- End Update --- */
    </style>
</head>
<body>
    <div id="realtime-indicator"></div> <!-- Real-time indicator -->
    <div class="container">
        <div class="header">
            <div id="profile-pic">U</div>
            <div id="user-info">
                <span id="username">Loading...</span>
                <span id="points-display">Points: 0</span>
                <span id="balance-display">Balance: $0.00</span>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <ul class="nav nav-tabs" id="mainTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#home-view">Home</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#earn-view">Earn</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#withdraw-view">Withdraw</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#referral-view">Referral</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile-view">Profile</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Home View -->
            <div id="home-view" class="view active">
                <div class="card">
                    <div class="card-header">Dashboard</div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="home-points">0</div>
                                <div class="stat-label">Points</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="home-balance">$0.00</div>
                                <div class="stat-label">Balance</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="home-referrals">0</div>
                                <div class="stat-label">Referrals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="home-ads-watched">0</div>
                                <div class="stat-label">Ads Watched</div>
                            </div>
                            <!-- --- Update: Add a stat item for the reset timer --- -->
                            <div class="stat-item">
                                <div class="stat-value" id="reset-timer-display">--:--:--</div>
                                <div class="stat-label">Reset Timer</div>
                            </div>
                            <!-- --- End Update --- -->
                        </div>

                        <h5>Important Notices</h5>
                        <div id="notices-container">
                            <p class="text-muted">Loading notices...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Recent Activity</div>
                    <div class="card-body">
                        <div id="activity-history">
                            <p class="text-muted">No recent activity.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Earn View -->
            <div id="earn-view" class="view">
                <div class="card">
                    <div class="card-header">Watch Ads & Earn</div>
                    <div class="card-body">
                        <p>Earn <strong><span id="points-per-ad">10</span> points</strong> for each ad you watch.</p>
                        <!-- --- Update: Display the dynamic reset timer value --- -->
                        <p>Ads reset after <strong><span id="reset-timer-hours-display">12</span> hours</strong> of your first ad view.</p>
                        <!-- --- End Update --- -->
                        
                        <div class="ad-section">
                            <h5>Available Ads</h5>
                            <div class="ad-grid" id="ad-grid">
                                <!-- Ads will be populated here -->
                                <p class="text-muted">Loading ads...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Withdraw View -->
            <div id="withdraw-view" class="view">
                <div class="card">
                    <div class="card-header">Withdraw Earnings</div>
                    <div class="card-body">
                        <p>Minimum withdrawal amount: $<span id="min-withdraw-amount">5.00</span></p>
                        <p>Your balance: $<span id="withdraw-balance">0.00</span></p>
                        
                        <div class="withdraw-section">
                            <div class="form-group">
                                <label for="paymentMethod" class="form-label">Payment Method</label>
                                <select class="form-control" id="paymentMethod">
                                    <option value="bkash">bKash</option>
                                    <option value="nagad">Nagad</option>
                                    <option value="rocket">Rocket</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="mobileNumber" class="form-label">Mobile Number</label>
                                <input type="text" class="form-control" id="mobileNumber" placeholder="Enter mobile number">
                            </div>
                            
                            <div class="form-group">
                                <label for="withdrawAmount" class="form-label">Amount ($)</label>
                                <input type="number" class="form-control" id="withdrawAmount" placeholder="Enter amount" step="0.01" min="0">
                            </div>
                            
                            <button class="btn btn-primary" id="requestWithdrawBtn" onclick="requestWithdraw()">Request Withdrawal</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Withdrawal History</div>
                    <div class="card-body">
                        <button class="btn btn-outline-primary btn-sm mb-2" onclick="openWithdrawHistoryModal()">View Full History</button>
                        <div id="recent-withdraw-history">
                            <p class="text-muted">No recent withdrawals.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral View -->
            <div id="referral-view" class="view">
                <div class="card">
                    <div class="card-header">Invite Friends</div>
                    <div class="card-body">
                        <p>Earn <strong><span id="referral-reward">10</span> points</strong> for each friend who joins using your link.</p>
                        
                        <div class="form-group">
                            <label class="form-label">Your Referral Link</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="referralLink" readonly>
                                <button class="btn btn-outline-secondary copy-btn" type="button" onclick="copyReferralLink()">Copy</button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="referral-count">0</div>
                                <div class="stat-label">Total Referrals</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="referral-earnings">0</div>
                                <div class="stat-label">Referral Earnings</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="referral-claim-threshold">0</div>
                                <div class="stat-label">Claim Threshold</div>
                            </div>
                        </div>
                        
                        <button class="btn btn-success" id="claimReferralBtn" onclick="claimReferralEarnings()" disabled>Claim Earnings</button>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profile-view" class="view">
                <div class="card">
                    <div class="card-header">Your Profile</div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Telegram ID</label>
                            <input type="text" class="form-control" id="profile-telegram-id" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="profile-username" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="profile-first-name" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="profile-last-name" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Language</label>
                            <input type="text" class="form-control" id="profile-language" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Messages</label>
                            <button class="btn btn-outline-info" onclick="openMessagesModal()">View Messages</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Blocked View -->
            <div id="blocked-view" class="view">
                <div class="blocked-view-content">
                    <div class="blocked-icon">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="blocked-message">
                        Your account has been blocked.
                    </div>
                    <p>Please contact support if you believe this is an error.</p>
                    <p><a href="https://t.me/your_support_bot" class="support-link" target="_blank">Contact Support</a></p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2023 Earning App. All rights reserved.</p>
        </div>
    </div>

    <!-- Withdraw History Modal -->
    <div id="withdraw-history-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeWithdrawHistoryModal()">&times;</span>
            <h4>Withdrawal History</h4>
            <div id="withdraw-history-list">
                <p class="text-muted">Loading history...</p>
            </div>
        </div>
    </div>

    <!-- Messages Modal -->
    <div id="messages-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMessagesModal()">&times;</span>
            <h4>Messages from Admin</h4>
            <div id="message-history">
                <p class="text-center text-muted">Loading messages...</p>
            </div>
            <div id="message-input-container">
                <input type="text" class="form-control" id="message-input" placeholder="Type your reply...">
                <button class="btn btn-outline-secondary" id="send-message-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyD3BGZ0MVLpbQbIpLUAnYvWNEIyk7Y6S0Q",
          authDomain: "earning-app-80258.firebaseapp.com",
          databaseURL: "https://earning-app-80258-default-rtdb.firebaseio.com",
          projectId: "earning-app-80258",
          storageBucket: "earning-app-80258.appspot.com",
          messagingSenderId: "25930019210",
          appId: "1:25930019210:web:6441562811d3e7e9631873",
          measurementId: "G-P9HX6XXT1Q"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Global State Variables ---
        let tgUser = null;
        let tg = window.Telegram.WebApp;
        let points = 0;
        let balance = 0.00;
        let referralCount = 0;
        let referralEarnings = 0;
        let adsWatchedToday = 0;
        let lastAdWatchTime = null; // This will be a Date object or null
        let isBlocked = false;
        let historyLog = [];
        let withdrawHistory = [];
        let appConfig = {
            pointsPerAd: 10,
            coinsForConversion: 1000,
            valuePerConversion: 0.30,
            referralRewardCoins: 10,
            referralClaimThreshold: 200,
            minWithdrawAmount: 5,
            dailyAdLimitPerUser: 10,
            isAdSystemActive: true,
            // --- Update: Add resetTimerHours with a default value ---
            resetTimerHours: 12 // Default to 12 hours if not set by admin
            // --- End Update ---
        };
        let adUrls = [
            "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
            "https://www.google.com",
            "https://www.github.com",
            "https://www.stackoverflow.com"
        ];

        // --- Firebase Listeners ---
        let userPointsBalanceListener = null;
        let userReferralListener = null;
        let userAdTrackingListener = null;
        let appConfigListener = null;
        let noticesListener = null;
        let adminMessagesListener = null;
        // --- Update: Add a variable for the real-time data interval ---
        let realTimeDataInterval = null;
        // --- Update: Add a variable for the reset timer interval ---
        let resetTimerInterval = null;
        // --- End Update ---

        // --- Utility Functions ---
        function updateDisplay() {
            document.getElementById('home-points').textContent = points;
            document.getElementById('home-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('home-referrals').textContent = referralCount;
            document.getElementById('home-ads-watched').textContent = adsWatchedToday;
            
            document.getElementById('points-display').textContent = `Points: ${points}`;
            document.getElementById('balance-display').textContent = `Balance: $${balance.toFixed(2)}`;
            
            document.getElementById('withdraw-balance').textContent = balance.toFixed(2);
            
            document.getElementById('referral-count').textContent = referralCount;
            document.getElementById('referral-earnings').textContent = referralEarnings;
            
            // Update referral link
            if (tgUser && tgUser.id) {
                document.getElementById('referralLink').value = `https://t.me/your_bot?start=${tgUser.id}`;
            }
        }

        function showMessageModal(title, message) {
            // Simple alert for now, can be replaced with a custom modal
            alert(`${title}\n\n${message}`);
        }

        function showBlockedView() {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById('blocked-view').classList.add('active');
        }

        function logout() {
            // Close the Web App
            tg.close();
        }

        // --- End Utility Functions ---

        // --- User Data Management ---
        async function loadTelegramUser() {
            try {
                tgUser = tg.initDataUnsafe.user;
                if (!tgUser || !tgUser.id) {
                    throw new Error("Unable to get Telegram user data.");
                }
                console.log("Telegram User Data:", tgUser);
                
                document.getElementById('username').textContent = tgUser.first_name || 'Telegram User';
                const profilePicDiv = document.getElementById('profile-pic');
                if (tgUser.photo_url) {
                    profilePicDiv.innerHTML = `<img src="${tgUser.photo_url}" alt="Profile Picture">`;
                } else {
                    profilePicDiv.textContent = (tgUser.first_name || 'U').charAt(0);
                }

                // Populate profile view
                document.getElementById('profile-telegram-id').value = tgUser.id;
                document.getElementById('profile-username').value = tgUser.username || 'N/A';
                document.getElementById('profile-first-name').value = tgUser.first_name || 'N/A';
                document.getElementById('profile-last-name').value = tgUser.last_name || 'N/A';
                document.getElementById('profile-language').value = tg.initDataUnsafe.user.language_code || 'N/A';

                // Set referral link
                document.getElementById('referralLink').value = `https://t.me/your_bot?start=${tgUser.id}`;

                // Load user data from Firebase
                await loadUserData();

                // Setup real-time listeners
                setupRealTimeListeners();

            } catch (error) {
                console.error("Error loading Telegram user:", error);
                showMessageModal('Error', 'Failed to load user data. Please try again.');
            }
        }

        async function loadUserData() {
            if (!tgUser || !tgUser.id) return;

            try {
                const userRef = database.ref('users/' + tgUser.id);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();

                if (userData) {
                    points = userData.points || 0;
                    balance = userData.balance || 0.00;
                    referralCount = userData.referralCount || 0;
                    referralEarnings = userData.referralEarnings || 0;
                    adsWatchedToday = userData.adsWatchedToday || 0;
                    isBlocked = userData.isBlocked || false;
                    historyLog = userData.historyLog || [];
                    withdrawHistory = userData.withdrawHistory ? Object.values(userData.withdrawHistory) : [];
                    
                    // Handle lastAdWatchTime correctly
                    if (userData.lastAdWatchTime) {
                        // If it's already a Date object string, parse it. Otherwise, assume it's a timestamp.
                        lastAdWatchTime = new Date(userData.lastAdWatchTime);
                        // Basic validation
                        if (isNaN(lastAdWatchTime.getTime())) {
                             console.warn("Invalid lastAdWatchTime format in DB, setting to null");
                             lastAdWatchTime = null;
                        }
                    } else {
                        lastAdWatchTime = null;
                    }

                    console.log("User data loaded from Firebase:", {
                        points, balance, referralCount, referralEarnings, adsWatchedToday, lastAdWatchTime, isBlocked
                    });
                } else {
                    // Create new user entry
                    await createUserEntry();
                }

                updateDisplay();
                renderActivityHistory();
                renderRecentWithdrawHistory();
                updateAdButtonStates(); // Initial button state check
                startResetTimer(); // Start the reset timer display

                if (isBlocked) {
                    showBlockedView();
                }

            } catch (error) {
                console.error("Error loading user data from Firebase:", error);
                showMessageModal('Error', 'Failed to load your data. Please try again.');
            }
        }

        async function createUserEntry() {
            if (!tgUser || !tgUser.id) return;

            try {
                const newUser = {
                    id: tgUser.id,
                    username: tgUser.username || null,
                    firstName: tgUser.first_name || null,
                    lastName: tgUser.last_name || null,
                    points: 0,
                    balance: 0.00,
                    referralCount: 0,
                    referralEarnings: 0,
                    adsWatchedToday: 0,
                    lastAdWatchTime: null, // Initialize as null
                    isBlocked: false,
                    adStatus: 'Active', // Default ad status
                    createdAt: new Date().toISOString(),
                    historyLog: [],
                    withdrawHistory: {}
                };

                await database.ref('users/' + tgUser.id).set(newUser);
                console.log("New user entry created in Firebase");

                // Update local state with default values
                points = newUser.points;
                balance = newUser.balance;
                referralCount = newUser.referralCount;
                referralEarnings = newUser.referralEarnings;
                adsWatchedToday = newUser.adsWatchedToday;
                lastAdWatchTime = null; // Should be null initially
                isBlocked = newUser.isBlocked;
                historyLog = newUser.historyLog;
                withdrawHistory = [];

            } catch (error) {
                console.error("Error creating new user entry:", error);
                showMessageModal('Error', 'Failed to create user profile. Please try again.');
            }
        }

        async function saveUserData() {
            if (!tgUser || !tgUser.id) return;

            try {
                await database.ref('users/' + tgUser.id).update({
                    points: points,
                    balance: balance,
                    historyLog: historyLog
                });
            } catch (error) {
                console.error("Failed to save user data:", error);
            }
        }

        // --- End User Data Management ---

        // --- Real-time Listeners Setup ---
        function setupRealTimeListeners() {
            if (!tgUser || !tgUser.id) return;

            const userRef = database.ref('users/' + tgUser.id);

            // Listener for points and balance
            if (userPointsBalanceListener) {
                userRef.child('points').off('value', userPointsBalanceListener);
                userRef.child('balance').off('value', userPointsBalanceListener);
            }
            userPointsBalanceListener = userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    points = userData.points || 0;
                    balance = userData.balance || 0.00;
                    updateDisplay();
                }
            });

            // Listener for referral data
            if (userReferralListener) {
                userRef.child('referralCount').off('value', userReferralListener);
                userRef.child('referralEarnings').off('value', userReferralListener);
            }
            userReferralListener = userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    referralCount = userData.referralCount || 0;
                    referralEarnings = userData.referralEarnings || 0;
                    updateDisplay();
                    document.getElementById('referral-count').textContent = referralCount;
                    document.getElementById('referral-earnings').textContent = referralEarnings;
                    
                    const claimBtn = document.getElementById('claimReferralBtn');
                    if (referralEarnings >= appConfig.referralClaimThreshold) {
                        claimBtn.disabled = false;
                    } else {
                        claimBtn.disabled = true;
                    }
                }
            });

            // Listener for ad tracking data
            if (userAdTrackingListener) {
                userRef.child('adsWatchedToday').off('value', userAdTrackingListener);
                userRef.child('lastAdWatchTime').off('value', userAdTrackingListener);
            }
            userAdTrackingListener = userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    const oldAdsWatchedToday = adsWatchedToday;
                    adsWatchedToday = userData.adsWatchedToday || 0;
                    
                    // Handle lastAdWatchTime correctly on update
                    if (userData.lastAdWatchTime) {
                        const newLastAdWatchTime = new Date(userData.lastAdWatchTime);
                        if (!isNaN(newLastAdWatchTime.getTime())) {
                             lastAdWatchTime = newLastAdWatchTime;
                        } else {
                             console.warn("Invalid lastAdWatchTime format received from DB update");
                        }
                    } else {
                        lastAdWatchTime = null;
                    }
                    
                    console.log("Ad tracking data updated from Firebase:", { adsWatchedToday, lastAdWatchTime });

                    // Only update button states if the count actually changed or time was updated
                    // This prevents unnecessary updates if other fields change
                    if (adsWatchedToday !== oldAdsWatchedToday || userData.lastAdWatchTime !== (lastAdWatchTime ? lastAdWatchTime.toISOString() : null)) {
                         updateAdButtonStates();
                    }
                }
            });

            // Listener for app configuration
            if (appConfigListener) {
                database.ref('appConfig').off('value', appConfigListener);
            }
            appConfigListener = database.ref('appConfig').on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    const oldLimit = appConfig.dailyAdLimitPerUser;
                    const oldStatus = appConfig.isAdSystemActive;
                    const oldResetTimerHours = appConfig.resetTimerHours; // Store old value
                    // --- Update: Ensure resetTimerHours is loaded from Firebase or defaults ---
                    appConfig = {
                        pointsPerAd: config.pointsPerAd !== undefined ? config.pointsPerAd : 10,
                        coinsForConversion: config.coinsForConversion !== undefined ? config.coinsForConversion : 1000,
                        valuePerConversion: config.valuePerConversion !== undefined ? config.valuePerConversion : 0.30,
                        referralRewardCoins: config.referralRewardCoins !== undefined ? config.referralRewardCoins : 10,
                        referralClaimThreshold: config.referralClaimThreshold !== undefined ? config.referralClaimThreshold : 200,
                        minWithdrawAmount: config.minWithdrawAmount !== undefined ? config.minWithdrawAmount : 5,
                        dailyAdLimitPerUser: config.dailyAdLimitPerUser !== undefined ? config.dailyAdLimitPerUser : 10,
                        isAdSystemActive: config.isAdSystemActive !== undefined ? config.isAdSystemActive : true,
                        // Load resetTimerHours from Firebase, defaulting to 12 if not present
                        resetTimerHours: config.resetTimerHours !== undefined ? config.resetTimerHours : 12
                    };
                    // --- End Update ---
                    console.log("App config updated:", appConfig);
                    updateDisplay();
                    // --- Update: Update UI elements that depend on resetTimerHours ---
                    document.getElementById('reset-timer-hours-display').textContent = appConfig.resetTimerHours;
                    document.getElementById('points-per-ad').textContent = appConfig.pointsPerAd;
                    document.getElementById('referral-reward').textContent = appConfig.referralRewardCoins;
                    document.getElementById('min-withdraw-amount').textContent = appConfig.minWithdrawAmount.toFixed(2);
                    document.getElementById('referral-claim-threshold').textContent = appConfig.referralClaimThreshold;
                    // --- End Update ---
                    
                    // Update button states when global config changes
                    updateAdButtonStates(); 

                    // If the limit, global status, or reset timer hours changed, we might need to update UI state
                    if (oldLimit !== appConfig.dailyAdLimitPerUser || 
                        oldStatus !== appConfig.isAdSystemActive || 
                        oldResetTimerHours !== appConfig.resetTimerHours) {
                        renderAdGrid(); // Re-render ads if limit changed
                        // Restart the timer display with the new value
                        startResetTimer(); 
                    }
                }
            });

            // Listener for notices
            if (noticesListener) {
                database.ref('notices').off('value', noticesListener);
            }
            noticesListener = database.ref('notices').on('value', (snapshot) => {
                const notices = snapshot.val();
                renderNotices(notices);
            });

            // Listener for admin messages
            if (adminMessagesListener) {
                userRef.child('adminMessages').off('value', adminMessagesListener);
            }
            adminMessagesListener = userRef.child('adminMessages').on('value', (snapshot) => {
                const messages = snapshot.val();
                // Check if messages modal is open to update history
                if (document.getElementById('messages-modal').style.display === 'block') {
                    renderMessageHistory(messages);
                }
            });
            
            // --- Update: Setup periodic real-time data fetching ---
            if (realTimeDataInterval) {
                 clearInterval(realTimeDataInterval);
            }
            // Fetch data every 5 seconds
            realTimeDataInterval = setInterval(fetchRealTimeData, 5000);
            // --- End Update ---
        }

        // --- Update: Function to fetch real-time data periodically ---
        async function fetchRealTimeData() {
             if (!tgUser || !tgUser.id) return;

             const indicator = document.getElementById('realtime-indicator');
             indicator.classList.add('updating'); // Show indicator

             try {
                 const userRef = database.ref('users/' + tgUser.id);
                 const snapshot = await userRef.once('value');
                 const userData = snapshot.val();

                 if (userData) {
                     // Update only the specific fields we want to track in real-time
                     const oldAdsWatchedToday = adsWatchedToday;
                     const oldLastAdWatchTime = lastAdWatchTime ? lastAdWatchTime.toISOString() : null;
                     
                     adsWatchedToday = userData.adsWatchedToday || 0;
                     
                     // Handle lastAdWatchTime correctly on real-time fetch
                     if (userData.lastAdWatchTime) {
                         const fetchedLastAdWatchTime = new Date(userData.lastAdWatchTime);
                         if (!isNaN(fetchedLastAdWatchTime.getTime())) {
                             lastAdWatchTime = fetchedLastAdWatchTime;
                         } else {
                             console.warn("Invalid lastAdWatchTime format fetched in real-time update");
                         }
                     } else {
                         lastAdWatchTime = null;
                     }

                     console.log("Real-time data fetched:", { adsWatchedToday, lastAdWatchTime });

                     // Update UI only if these specific values changed
                     if (adsWatchedToday !== oldAdsWatchedToday || 
                         (lastAdWatchTime ? lastAdWatchTime.toISOString() : null) !== oldLastAdWatchTime) {
                         updateAdButtonStates();
                         // Also update display if adsWatchedToday changed
                         if(adsWatchedToday !== oldAdsWatchedToday) {
                              document.getElementById('home-ads-watched').textContent = adsWatchedToday;
                         }
                     }
                 }
             } catch (error) {
                 console.error("Error fetching real-time data:", error);
             } finally {
                 // Use a short timeout to make the indicator visible even for fast requests
                 setTimeout(() => {
                     indicator.classList.remove('updating'); // Hide indicator
                 }, 200);
             }
        }
        // --- End Update ---

        // --- End Real-time Listeners Setup ---

        // --- Ad Management ---
        function renderAdGrid() {
            const adGrid = document.getElementById('ad-grid');
            adGrid.innerHTML = ''; // Clear existing ads

            if (!appConfig.isAdSystemActive) {
                adGrid.innerHTML = '<p class="text-muted">Ad system is currently inactive.</p>';
                return;
            }

            for (let i = 0; i < appConfig.dailyAdLimitPerUser; i++) {
                const adCard = document.createElement('div');
                adCard.className = 'ad-card';
                adCard.innerHTML = `
                    <img src="https://picsum.photos/200/100?random=${i}" alt="Ad ${i+1}" class="ad-image">
                    <div class="ad-content">
                        <div class="ad-title">Ad ${i+1}</div>
                        <div class="ad-reward">+${appConfig.pointsPerAd} Points</div>
                        <button class="ad-button" id="ad-btn-${i}" onclick="watchAd(${i})">Watch Ad</button>
                    </div>
                `;
                adGrid.appendChild(adCard);
            }
            updateAdButtonStates(); // Set initial button states after rendering
        }

        // --- Update: Modified updateAdButtonStates to use appConfig.resetTimerHours ---
        async function updateAdButtonStates() {
            if (!tgUser || !tgUser.id) return;

            // Check and reset the ad counter based on the dynamic timer
            await checkAndResetAdCounter();

            const adButtons = document.querySelectorAll('.ad-button');
            const isAtLimit = adsWatchedToday >= appConfig.dailyAdLimitPerUser;
            const isSystemActive = appConfig.isAdSystemActive;

            adButtons.forEach((button, index) => {
                if (!isSystemActive) {
                    button.disabled = true;
                    button.textContent = 'Inactive';
                } else if (isAtLimit) {
                    button.disabled = true;
                    button.textContent = 'Limit Reached';
                } else {
                    button.disabled = false;
                    button.textContent = 'Watch Ad';
                }
            });
        }

        // --- Update: New function to check and reset the ad counter based on dynamic timer ---
        async function checkAndResetAdCounter() {
            if (!tgUser || !tgUser.id) return;

            // If lastAdWatchTime is not set, it means the user hasn't watched any ads yet in this cycle
            // We don't need to reset anything, just let them watch the first ad which will set the time.
            if (!lastAdWatchTime) {
                console.log("No lastAdWatchTime set, counter is fresh or was reset.");
                return; // Nothing to check/reset
            }

            const now = new Date();
            const timeDiffMs = now - lastAdWatchTime; // Difference in milliseconds
            const hoursDiff = timeDiffMs / (1000 * 60 * 60); // Convert to hours

            console.log(`Checking timer: ${hoursDiff.toFixed(2)} hours passed (need ${appConfig.resetTimerHours} hours)`);

            // Check if the time set by admin (appConfig.resetTimerHours) has passed
            if (hoursDiff >= appConfig.resetTimerHours) {
                console.log(`Reset timer (${appConfig.resetTimerHours} hours) has passed. Resetting counter.`);
                // Reset the counter if it's not already 0
                if (adsWatchedToday !== 0) {
                    adsWatchedToday = 0;
                    try {
                        await database.ref('users/' + tgUser.id).update({
                            adsWatchedToday: adsWatchedToday
                            // Do not update lastAdWatchTime here. It should only be updated when a new ad viewing cycle starts.
                        });
                        console.log("Ad counter reset successfully in Firebase.");
                        updateDisplay(); // Update display to reflect reset
                        // updateAdButtonStates() will be called by the listener, but we can call it explicitly if needed
                        // updateAdButtonStates();
                    } catch (error) {
                        console.error("Failed to reset ad counter:", error);
                        // Optionally inform the user
                    }
                } else {
                     console.log("Ad counter was already 0, no Firebase update needed.");
                }
            } else {
                console.log(`Reset timer (${appConfig.resetTimerHours} hours) has not passed yet.`);
            }
        }
        // --- End Update ---

        // Flag to prevent multiple simultaneous ad requests
        let isAdRequestPending = false;

        async function watchAd(adIndex) {
            if (isBlocked) {
                showBlockedView();
                return;
            }

            if (isAdRequestPending) {
                console.log("Ad request already in progress.");
                return;
            }

            // Double-check limit before proceeding
            if (adsWatchedToday >= appConfig.dailyAdLimitPerUser) {
                showMessageModal('Limit Reached', `You have reached your daily limit of ${appConfig.dailyAdLimitPerUser} ads.`);
                updateAdButtonStates();
                return;
            }

            // --- Update: Ensure lastAdWatchTime is set when the first ad is watched in a new cycle ---
            let shouldSetLastAdWatchTime = false;
            if (!lastAdWatchTime) {
                console.log("First ad in a new cycle, will set lastAdWatchTime.");
                shouldSetLastAdWatchTime = true;
            }
            // --- End Update ---

            isAdRequestPending = true;
            const adBtn = document.getElementById(`ad-btn-${adIndex}`);
            const originalText = adBtn.textContent;
            adBtn.textContent = 'Processing...';
            adBtn.disabled = true;
            adBtn.classList.add('requesting');

            try {
                // --- Update: Set lastAdWatchTime in Firebase if needed ---
                if (shouldSetLastAdWatchTime) {
                    const currentTime = new Date();
                    await database.ref('users/' + tgUser.id).update({
                        lastAdWatchTime: currentTime.toISOString()
                    });
                    lastAdWatchTime = currentTime; // Update local state
                    console.log("Set lastAdWatchTime to:", lastAdWatchTime);
                    // Restart the timer display as it's a new cycle
                    startResetTimer();
                }
                // --- End Update ---

                // Simulate ad watching process
                // In a real app, you would open the ad link here
                // window.open(adUrls[adIndex % adUrls.length], '_blank');
                
                // For demo, we'll just simulate a delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Grant reward
                await grantReward();

                // Update tracking
                await updateAdTracking();

                // Show success message
                showMessageModal('Success', `You earned ${appConfig.pointsPerAd} points!`);

            } catch (err) {
                console.error("Error attempting to watch ad:", err);
                showMessageModal('Error', 'An error occurred while processing your ad. Please try again.');
            } finally {
                adBtn.textContent = originalText;
                adBtn.disabled = false;
                adBtn.classList.remove('requesting');
                isAdRequestPending = false;
            }
        }

        async function updateAdTracking() {
            if (!tgUser || !tgUser.id) return;

            adsWatchedToday += 1;
            // lastAdWatchTime is now set either initially or when the timer resets
            // We only update it when the FIRST ad is watched in a new cycle (see watchAd)
            // lastAdWatchTime = new Date(); // <-- This line is removed or commented out

            try {
                const updateData = {
                    adsWatchedToday: adsWatchedToday
                    // lastAdWatchTime is NOT updated here anymore
                };
                await database.ref('users/' + tgUser.id).update(updateData);
                console.log("Ad tracking updated in Firebase:", updateData);
            } catch (error) {
                console.error("Failed to update ad tracking:", error);
            }
        }

        async function grantReward() {
            if (!tgUser || !tgUser.id) return;

            points += appConfig.pointsPerAd;
            
            // Convert points to balance
            // Ensure conversion is based on the latest appConfig values
            const earnedBalance = (appConfig.valuePerConversion / appConfig.coinsForConversion) * appConfig.pointsPerAd;
            balance += earnedBalance;

            // Add to history
            addToHistory('Ad Reward', `Earned ${appConfig.pointsPerAd} points and $${earnedBalance.toFixed(2)} for watching an ad.`);

            updateDisplay();
            await saveUserData();
        }

        // --- End Ad Management ---

        // --- Withdrawal Logic ---
        // Flag to prevent multiple withdrawal requests
        let isWithdrawRequestPending = false;

        async function requestWithdraw() {
            if (isBlocked) {
                showBlockedView();
                return;
            }

            // Prevent multiple simultaneous requests using flag
            if (isWithdrawRequestPending) {
                console.log("Withdrawal request already in progress.");
                return;
            }

            // Validation
            const paymentMethod = document.getElementById('paymentMethod').value;
            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);

            if (!paymentMethod || !mobileNumber || isNaN(amount) || amount <= 0) {
                showMessageModal('Error', 'Please fill in all fields correctly.');
                return;
            }

            if (amount > balance) {
                showMessageModal('Error', 'Insufficient balance.');
                return;
            }

            if (amount < appConfig.minWithdrawAmount) {
                showMessageModal('Error', `Minimum withdrawal amount is $${appConfig.minWithdrawAmount.toFixed(2)}.`);
                return;
            }

            // Set flag to true at the start of the request
            isWithdrawRequestPending = true;

            // Update UI to show request is processing
            const requestBtn = document.getElementById('requestWithdrawBtn');
            const originalText = requestBtn.textContent;
            requestBtn.textContent = 'Requesting...';
            requestBtn.classList.remove('btn-primary');
            requestBtn.classList.add('btn-secondary'); // Using BS class for disabled look
            requestBtn.disabled = true;

            try {
                // Create withdraw request with Pending status
                const withdrawRequest = {
                    id: Date.now().toString(), // This should be unique per request
                    userId: tgUser.id,
                    username: tgUser.username || 'Unknown',
                    method: paymentMethod,
                    mobileNumber: mobileNumber,
                    amount: amount.toFixed(2),
                    status: 'Pending',
                    timestamp: new Date().toISOString()
                };

                // Save to Firebase
                const userRef = database.ref('users/' + tgUser.id);
                await userRef.child('withdrawHistory').push(withdrawRequest);

                // Immediately deduct balance and update points in Firebase
                balance -= amount;
                // Ensure points are calculated correctly and don't go negative
                points = Math.max(0, Math.round((balance / appConfig.valuePerConversion) * appConfig.coinsForConversion));

                updateDisplay();
                await saveUserData(); // This now only saves points, balance, historyLog

                // Add to local withdrawHistory array for immediate display in modal if open
                withdrawHistory.unshift(withdrawRequest);
                if (document.getElementById('withdraw-history-modal').classList.contains('active')) {
                    renderWithdrawHistoryModal();
                }

                // Add to activity history
                addToHistory('Withdrawal Request', `Requested $${amount.toFixed(2)} to ${paymentMethod} (${mobileNumber}). Status: Pending.`);

                // Show success message
                showMessageModal('Success', 'Withdrawal request submitted successfully.');

                // Reset form
                document.getElementById('mobileNumber').value = '';
                document.getElementById('withdrawAmount').value = '';

            } catch (error) {
                console.error("Withdrawal request failed:", error);
                showMessageModal('Error', 'Failed to submit withdrawal request. Please try again.');
                
                // Restore button state on error
                requestBtn.textContent = originalText;
                requestBtn.classList.remove('btn-secondary');
                requestBtn.classList.add('btn-primary');
                requestBtn.disabled = false;
                
            } finally {
                // Reset flag and button state in the finally block to ensure it always runs
                isWithdrawRequestPending = false;
                requestBtn.textContent = originalText;
                requestBtn.classList.remove('btn-secondary');
                requestBtn.classList.add('btn-primary');
                requestBtn.disabled = false;
            }
        }

        function openWithdrawHistoryModal() {
            document.getElementById('withdraw-history-modal').style.display = 'block';
            renderWithdrawHistoryModal();
        }

        function closeWithdrawHistoryModal() {
            document.getElementById('withdraw-history-modal').style.display = 'none';
        }

        function renderWithdrawHistoryModal() {
            const historyList = document.getElementById('withdraw-history-list');
            historyList.innerHTML = '';

            if (withdrawHistory.length === 0) {
                historyList.innerHTML = '<p class="text-muted">No withdrawal history yet.</p>';
                return;
            }

            // Sort by timestamp descending
            const sortedHistory = [...withdrawHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedHistory.forEach(request => {
                const item = document.createElement('div');
                item.className = 'history-item';
                // Determine status badge class
                let statusClass = 'bg-secondary';
                if (request.status === 'Success') statusClass = 'bg-success';
                else if (request.status === 'Rejected') statusClass = 'bg-danger';
                else if (request.status === 'Processing') statusClass = 'bg-warning text-dark';
                
                item.innerHTML = `
                    <div><strong>Amount:</strong> $${request.amount}</div>
                    <div><strong>Method:</strong> ${request.method}</div>
                    <div><strong>Mobile:</strong> ${request.mobileNumber}</div>
                    <div><strong>Date:</strong> ${new Date(request.timestamp).toLocaleString()}</div>
                    <div><strong>Status:</strong> <span class="badge ${statusClass}">${request.status}</span></div>
                `;
                historyList.appendChild(item);
            });
        }

        function renderRecentWithdrawHistory() {
            const historyContainer = document.getElementById('recent-withdraw-history');
            historyContainer.innerHTML = '';

            if (withdrawHistory.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted">No recent withdrawals.</p>';
                return;
            }

            // Sort by timestamp descending and get the last 3
            const sortedHistory = [...withdrawHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentHistory = sortedHistory.slice(0, 3);

            recentHistory.forEach(request => {
                const item = document.createElement('div');
                item.className = 'history-item';
                 // Determine status badge class
                let statusClass = 'bg-secondary';
                if (request.status === 'Success') statusClass = 'bg-success';
                else if (request.status === 'Rejected') statusClass = 'bg-danger';
                else if (request.status === 'Processing') statusClass = 'bg-warning text-dark';
                
                item.innerHTML = `
                    <div><strong>$${request.amount}</strong> to ${request.method}</div>
                    <div><small>${new Date(request.timestamp).toLocaleDateString()}</small></div>
                    <div><span class="badge ${statusClass}">${request.status}</span></div>
                `;
                historyContainer.appendChild(item);
            });
        }

        // --- End Withdrawal Logic ---

        // --- Referral Logic ---
        function copyReferralLink() {
            const referralLinkInput = document.getElementById('referralLink');
            referralLinkInput.select();
            referralLinkInput.setSelectionRange(0, 99999); /* For mobile devices */
            document.execCommand("copy");
            
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        }

        async function claimReferralEarnings() {
            if (isBlocked) {
                showBlockedView();
                return;
            }

            if (referralEarnings < appConfig.referralClaimThreshold) {
                showMessageModal('Error', `You need at least ${appConfig.referralClaimThreshold} referral earnings to claim.`);
                return;
            }

            try {
                // Convert referral earnings to points
                const pointsToAdd = referralEarnings; // Assuming 1 point = 1 coin
                points += pointsToAdd;
                
                // Convert points to balance
                const balanceToAdd = (appConfig.valuePerConversion / appConfig.coinsForConversion) * pointsToAdd;
                balance += balanceToAdd;

                // Reset referral earnings
                referralEarnings = 0;

                // Update Firebase
                await database.ref('users/' + tgUser.id).update({
                    points: points,
                    balance: balance,
                    referralEarnings: 0
                });

                // Add to history
                addToHistory('Referral Claim', `Claimed ${pointsToAdd} points ($${balanceToAdd.toFixed(2)}) from referrals.`);

                updateDisplay();
                document.getElementById('claimReferralBtn').disabled = true;

                showMessageModal('Success', `You have successfully claimed ${pointsToAdd} points ($${balanceToAdd.toFixed(2)}) from referrals!`);

            } catch (error) {
                console.error("Failed to claim referral earnings:", error);
                showMessageModal('Error', 'Failed to claim referral earnings. Please try again.');
            }
        }

        // --- End Referral Logic ---

        // --- History Logic ---
        function addToHistory(type, detail) {
            const timestamp = new Date().toISOString();
            const historyItem = { type, detail, timestamp };
            historyLog.push(historyItem);
            
            // Keep only the last 50 items
            if (historyLog.length > 50) {
                historyLog.shift();
            }
            
            // Update Firebase
            // saveUserData(); // This is called by grantReward etc.
            
            // Update UI
            renderActivityHistory();
        }

        function renderActivityHistory() {
            const historyContainer = document.getElementById('activity-history');
            historyContainer.innerHTML = '';

            if (historyLog.length === 0) {
                historyContainer.innerHTML = '<p class="text-muted">No recent activity.</p>';
                return;
            }

            // Sort by timestamp descending and get the last 5
            const sortedHistory = [...historyLog].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentHistory = sortedHistory.slice(0, 5);

            recentHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-date">${new Date(item.timestamp).toLocaleString()}</div>
                    <div class="history-detail"><strong>${item.type}:</strong> ${item.detail}</div>
                `;
                historyContainer.appendChild(historyItem);
            });
        }

        // --- End History Logic ---

        // --- Notices Logic ---
        function renderNotices(noticesData) {
            const noticesContainer = document.getElementById('notices-container');
            noticesContainer.innerHTML = '';

            if (!noticesData || Object.keys(noticesData).length === 0) {
                noticesContainer.innerHTML = '<p class="text-muted">No notices at the moment.</p>';
                return;
            }

            // Convert to array and sort by timestamp descending
            const noticesArray = Object.values(noticesData);
            noticesArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            noticesArray.forEach(notice => {
                const noticeItem = document.createElement('div');
                noticeItem.className = 'notice-item';
                noticeItem.innerHTML = `
                    <div class="notice-title">${notice.title}</div>
                    <div class="notice-message">${notice.message}</div>
                    <div class="notice-date">${new Date(notice.timestamp).toLocaleString()}</div>
                `;
                noticesContainer.appendChild(noticeItem);
            });
        }

        // --- End Notices Logic ---

        // --- Messages Logic ---
        function openMessagesModal() {
            document.getElementById('messages-modal').style.display = 'block';
            loadMessageHistory();
        }

        function closeMessagesModal() {
            document.getElementById('messages-modal').style.display = 'none';
        }

        async function loadMessageHistory() {
            if (!tgUser || !tgUser.id) return;

            try {
                const userRef = database.ref('users/' + tgUser.id);
                const snapshot = await userRef.child('adminMessages').once('value');
                const messages = snapshot.val();
                renderMessageHistory(messages);
            } catch (error) {
                console.error("Error loading message history:", error);
                document.getElementById('message-history').innerHTML = '<p class="text-center text-danger">Failed to load messages.</p>';
            }
        }

        function renderMessageHistory(messagesData) {
            const historyDiv = document.getElementById('message-history');
            if (!messagesData) {
                historyDiv.innerHTML = '<p class="text-center text-muted">No messages yet. Start a conversation!</p>';
                return;
            }

            const messages = Object.values(messagesData);
            // Sort messages by timestamp (oldest first for correct display order)
            messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            historyDiv.innerHTML = ''; // Clear previous content
            messages.forEach(msg => {
                const isUser = msg.sender === 'user';
                // Apply correct class based on sender
                const bubbleClass = isUser ? 'user-message' : 'admin-message';
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-bubble ${bubbleClass}`;
                messageDiv.innerHTML = `
                    ${msg.text}
                    <br><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                `;
                historyDiv.appendChild(messageDiv);
            });

            // Scroll to bottom
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (!messageText || !tgUser || !tgUser.id) {
                return;
            }

            const messageData = {
                sender: 'user', // Mark message as from user
                text: messageText,
                timestamp: new Date().toISOString()
            };

            try {
                await database.ref(`users/${tgUser.id}/adminMessages`).push(messageData);
                console.log("Message sent to Firebase");
                input.value = ''; // Clear input
                // Re-load messages to show the new one
                // The listener will update the UI automatically, but we can also call loadMessageHistory
                // loadMessageHistory();
            } catch (error) {
                console.error("Error sending message:", error);
                showMessageModal('Error', 'Failed to send message. Please try again.');
            }
        }

        // --- End Messages Logic ---

        // --- View Management ---
        function showView(viewId) {
            // Prevent navigation if user is blocked (except to blocked view)
            if (isBlocked && viewId !== 'blocked-view') {
                showBlockedView();
                return;
            }

            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Specific actions for views
            if (viewId === 'earn-view') {
                renderAdGrid();
            } else if (viewId === 'withdraw-view') {
                document.getElementById('min-withdraw-amount').textContent = appConfig.minWithdrawAmount.toFixed(2);
                document.getElementById('withdraw-balance').textContent = balance.toFixed(2);
            } else if (viewId === 'referral-view') {
                document.getElementById('referral-reward').textContent = appConfig.referralRewardCoins;
                document.getElementById('referral-claim-threshold').textContent = appConfig.referralClaimThreshold;
                const claimBtn = document.getElementById('claimReferralBtn');
                if (referralEarnings >= appConfig.referralClaimThreshold) {
                    claimBtn.disabled = false;
                } else {
                    claimBtn.disabled = true;
                }
            }
        }

        // --- Update: Dynamic Reset Timer Display Logic ---
        function startResetTimer() {
            // Clear any existing interval
            if (resetTimerInterval) {
                clearInterval(resetTimerInterval);
            }

            // Update display immediately
            updateResetTimerDisplay();

            // Update display every second
            resetTimerInterval = setInterval(updateResetTimerDisplay, 1000);
        }

        function updateResetTimerDisplay() {
            const timerDisplay = document.getElementById('reset-timer-display');
            
            // If lastAdWatchTime is not set, timer is not running
            if (!lastAdWatchTime) {
                timerDisplay.textContent = '--:--:--';
                return;
            }

            const now = new Date();
            const timeDiffMs = now - lastAdWatchTime; // Difference in milliseconds
            const hoursDiff = timeDiffMs / (1000 * 60 * 60); // Convert to hours

            // If the timer has already expired, show 00:00:00
            if (hoursDiff >= appConfig.resetTimerHours) {
                timerDisplay.textContent = '00:00:00';
                return;
            }

            // Calculate remaining time
            const remainingHours = appConfig.resetTimerHours - hoursDiff;
            const totalSeconds = Math.floor(remainingHours * 3600);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            timerDisplay.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        // --- End Update ---

        // --- End View Management ---

        // --- Initialize App ---
        window.onload = function() {
            // Expand the web app to full screen
            tg.expand();
            
            // Set back button behavior
            tg.BackButton.onClick(() => {
                // If a modal is open, close it. Otherwise, close the web app.
                if (document.getElementById('withdraw-history-modal').style.display === 'block') {
                    closeWithdrawHistoryModal();
                } else if (document.getElementById('messages-modal').style.display === 'block') {
                    closeMessagesModal();
                } else {
                    tg.close();
                }
            });

            // Load user and initialize
            loadTelegramUser().then(() => {
                // Initial render of dynamic content
                document.getElementById('points-per-ad').textContent = appConfig.pointsPerAd;
                document.getElementById('referral-reward').textContent = appConfig.referralRewardCoins;
                document.getElementById('min-withdraw-amount').textContent = appConfig.minWithdrawAmount.toFixed(2);
                document.getElementById('referral-claim-threshold').textContent = appConfig.referralClaimThreshold;
                document.getElementById('reset-timer-hours-display').textContent = appConfig.resetTimerHours; // Initial display
                
                renderAdGrid();
            }).catch(error => {
                console.error("Failed to initialize app:", error);
                showMessageModal('Error', 'Failed to initialize the app. Please try again.');
            });
        };

        // --- Cleanup Listeners on Unload ---
        window.addEventListener('beforeunload', () => {
            if (userPointsBalanceListener && tgUser && tgUser.id) {
                const userRef = database.ref('users/' + tgUser.id);
                userRef.child('points').off('value', userPointsBalanceListener);
                userRef.child('balance').off('value', userPointsBalanceListener);
            }
            if (userReferralListener && tgUser && tgUser.id) {
                const userRef = database.ref('users/' + tgUser.id);
                userRef.child('referralCount').off('value', userReferralListener);
                userRef.child('referralEarnings').off('value', userReferralListener);
            }
            if (userAdTrackingListener && tgUser && tgUser.id) {
                const userRef = database.ref('users/' + tgUser.id);
                userRef.child('adsWatchedToday').off('value', userAdTrackingListener);
                userRef.child('lastAdWatchTime').off('value', userAdTrackingListener);
            }
            if (appConfigListener) {
                database.ref('appConfig').off('value', appConfigListener);
            }
            if (noticesListener) {
                database.ref('notices').off('value', noticesListener);
            }
            if (adminMessagesListener && tgUser && tgUser.id) {
                const userRef = database.ref('users/' + tgUser.id);
                userRef.child('adminMessages').off('value', adminMessagesListener);
                adminMessagesListener = null;
            }
            // --- Update: Clear the real-time data interval ---
            if (realTimeDataInterval) {
                 clearInterval(realTimeDataInterval);
            }
            // --- Update: Clear the reset timer interval ---
            if (resetTimerInterval) {
                 clearInterval(resetTimerInterval);
            }
            // --- End Update ---
        });
        // --- End Cleanup ---
    </script>
</body>
</html>
```
