<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>App (Fully Functional & Admin Controlled)</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        /* আপনার দেওয়া সকল CSS এখানে অপরিবর্তিত আছে */
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background-color: #000000; color: #ffffff; display: flex; flex-direction: column; height: 100vh; overscroll-behavior-y: contain; }
        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 20px; background-color: #000000; }
        .auth-card { background-color: #1c1c1e; border-radius: 10px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .auth-title { color: #00aaff; text-align: center; margin-bottom: 25px; font-size: 22px; font-weight: bold; }
        .auth-form .form-group { margin-bottom: 15px; }
        .auth-form label { display: block; margin-bottom: 6px; font-size: 14px; color: #cccccc; }
        .auth-form input { width: 100%; padding: 12px; border: 1px solid #3a3a3c; border-radius: 6px; font-size: 15px; background-color: #2c2c2e; color: #ffffff; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 12px; background-color: #007aff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        .auth-btn:hover { background-color: #0056b3; }
        .auth-btn:disabled { background-color: #555555; cursor: not-allowed; opacity: 0.7; }
        .auth-toggle { text-align: center; margin-top: 15px; color: #8e8e93; font-size: 14px; }
        .auth-toggle a { color: #00aaff; text-decoration: none; cursor: pointer; }
        .auth-error { color: #ff3b30; font-size: 14px; text-align: center; margin-top: 10px; min-height: 20px; }
        .app-container { flex-grow: 1; overflow-y: auto; padding-bottom: 70px; background-color: #000000; position: relative; display: none; }
        .app-header { background-color: #1a1a1a; color: #ffffff; padding: 12px 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 1001; border-bottom: 1px solid #333333; }
        .app-header .title { font-size: 18px; font-weight: bold; flex-grow: 1; }
        .app-header .user-info-header { display: flex; align-items: center; flex-grow: 1; }
        .app-header .avatar-small { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; border: 1px solid #555555; object-fit: cover; background-color: #333333; }
        .app-header .user-details { font-size: 12px; line-height: 1.3; }
        .app-header .user-name-header { font-weight: bold; font-size: 14px; }
        .app-header .user-phone-header { font-size: 11px; opacity: 0.7; }
        .app-header .actions { font-size: 22px; }
        .app-header .actions span { margin-left: 15px; cursor: pointer; }
        .screen { display: none; padding: 0; }
        .screen.active { display: block; }
        .content-padding { padding: 15px; }
        .profile-summary { text-align: center; padding: 20px 15px; background-color: #000000; margin-bottom: 10px; }
        .profile-summary .avatar-large { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 12px; border: 2px solid #00aaff; object-fit: cover; background-color: #444444; }
        .profile-summary .user-name-profile { font-size: 20px; font-weight: bold; color: #ffffff; }
        .profile-summary .user-balance-profile { font-size: 15px; color: #bbbbbb; margin-top: 6px; }
        .info-card { background-color: #1c1c1e; color: #ffffff; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .info-card h3 { margin-top: 0; margin-bottom: 12px; font-size: 17px; color: #00aaff; border-bottom: 1px solid #3a3a3c; padding-bottom: 8px; }
        .info-card p { margin: 8px 0; font-size: 15px; display: flex; justify-content: space-between; }
        .info-card p span:last-child { font-weight: bold; color: #ffffff; }
        .info-card p.referral-details-text { display: block; line-height: 1.5; }
        .btn { display: block; width: 100%; padding: 12px; background-color: #007aff; color: white; border: none; border-radius: 8px; font-size: 17px; font-weight: bold; text-align: center; cursor: pointer; margin-top: 20px; box-sizing: border-box; }
        .btn:hover { background-color: #0056b3; }
        .btn.btn-share { background-color: #0088cc; margin-top: 10px; }
        .btn.btn-auto { background-color: #34c759; margin-top: 10px; }
        .btn.btn-stop { background-color: #ff3b30; margin-top: 10px; }
        .form-group input, .form-group select { width: 100%; padding: 11px; border: 1px solid #3a3a3c; border-radius: 6px; font-size: 15px; background-color: #2c2c2e; color: #ffffff; box-sizing: border-box; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: #1a1a1a; border-top: 1px solid #333333; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -1px 5px rgba(0,0,0,0.2); z-index: 1000; }
        .bottom-nav .nav-item { display: flex; flex-direction: column; align-items: center; color: #8e8e93; cursor: pointer; padding: 5px 10px; font-size: 11px; flex-basis: 0; flex-grow: 1; }
        .bottom-nav .nav-item .icon { font-size: 22px; margin-bottom: 2px; }
        .bottom-nav .nav-item.active { color: #00aaff; }
        .telegram-contact-fab { position: fixed; bottom: 75px; right: 20px; width: 50px; height: 50px; background-color: #0088cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 999; }
        .telegram-contact-fab svg { width: 28px; height: 28px; fill: white; }
        .withdrawal-history-card { min-height: 100px; overflow-y: hidden; }
        .withdrawal-list li { opacity: 0; transform: translateY(15px); animation: fadeInSlideUp 0.6s forwards; }
        @keyframes fadeInSlideUp { to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//solseewuthi.net/sdk.js' data-zone='9344336' data-sdk='show_9344336' async></script>
</head>
<body>
    <!-- Auth Pages -->
    <div id="authContainer" class="auth-container">
        <div id="loginCard" class="auth-card">
            <h1 class="auth-title">Login to Your Account</h1>
            <form id="loginForm" class="auth-form">
                <div class="form-group"><label for="loginEmail">Email</label><input type="email" id="loginEmail" required></div>
                <div class="form-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div>
                <div id="loginError" class="auth-error"></div>
                <button type="submit" id="loginButton" class="auth-btn">Login</button>
                <p class="auth-toggle">Don't have an account? <a id="showSignup">Sign up</a></p>
            </form>
        </div>
        <div id="signupCard" class="auth-card" style="display: none;">
            <h1 class="auth-title">Create New Account</h1>
            <form id="signupForm" class="auth-form">
                <div class="form-group"><label for="signupName">Name</label><input type="text" id="signupName" required></div>
                <div class="form-group"><label for="signupEmail">Email</label><input type="email" id="signupEmail" required></div>
                <div class="form-group"><label for="signupPassword">Password</label><input type="password" id="signupPassword" required></div>
                <div class="form-group"><label for="signupConfirmPassword">Confirm Password</label><input type="password" id="signupConfirmPassword" required></div>
                <div id="signupError" class="auth-error"></div>
                <button type="submit" id="signupButton" class="auth-btn">Sign Up</button>
                <p class="auth-toggle">Already have an account? <a id="showLogin">Login</a></p>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container">
        <div id="homeScreen" class="screen">
            <div class="app-header">
                <div class="user-info-header">
                    <img id="headerUserAvatar" src="" alt=" " class="avatar-small">
                    <div class="user-details">
                        <div id="headerUserName" class="user-name-header"></div>
                        <div id="headerUserPhone" class="user-phone-header"></div>
                    </div>
                </div>
                <div class="actions"><span id="logoutButton">⋮</span></div>
            </div>
            <div class="profile-summary">
                <img id="profileSummaryUserAvatar" src="" alt=" " class="avatar-large">
                <div id="profileSummaryUserName" class="user-name-profile"></div>
                <div id="profileSummaryUserBalance" class="user-balance-profile"></div>
            </div>
            <div class="content-padding">
                <div class="info-card"><h3>Summary</h3><p><span>Tasks Completed Today:</span> <span id="homeMonetagTasksCompleted"></span></p><p><span>Daily Limit:</span> <span id="homeMonetagDailyLimit"></span></p></div>
                <div class="info-card"><h3>Earnings</h3><p><span>Total Earnings (USDT):</span> <span id="homeTotalMonetagEarnings"></span></p></div>
                <div class="withdrawal-history-card"><h3>Recent Withdrawals</h3><ul class="withdrawal-list" id="withdrawalHistoryList"></ul></div>
            </div>
        </div>
        <div id="earnScreen" class="screen">
            <div class="app-header"><div class="title">Earn Tasks</div></div>
            <div class="content-padding">
                <div class="info-card"><h3>Monetag Tasks</h3><p><span>Daily Limit:</span> <span id="earnMonetagDailyLimit"></span></p><p><span>Completed Today:</span> <span id="earnMonetagCompletedToday"></span></p><p><span>Remaining Today:</span> <span id="earnMonetagRemainingToday"></span></p></div>
                <button class="btn" id="startTaskMonetagButton">Start Task Monetag</button>
                <button class="btn btn-auto" id="autoTaskCompleteButton">Auto Touch Complete</button>
                <button class="btn btn-stop" id="stopAutoTaskButton" style="display: none;">Stop Auto Task</button>
                <div id="adStatusMessage" style="text-align:center; margin-top:15px; min-height:20px;"></div>
            </div>
        </div>
        <div id="referScreen" class="screen">
             <div class="app-header"><div class="title">Refer & Earn</div></div>
             <div class="content-padding">
                <div class="info-card"><h3>Your Referral Link</h3>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;"><input type="text" id="referralLink" readonly><button id="copyReferralLinkButton" class="btn" style="padding: 11px 15px; margin-top: 0; width: auto;">Copy</button></div>
                    <p id="copyStatusMessage" style="font-size: 12px; color: #34c759; min-height: 18px; text-align: right;"></p>
                    <button id="shareReferralLinkButton" class="btn btn-share">Share Now</button>
                </div>
                <div class="info-card"><h3>Statistics</h3><p><span>Total Shares/Copies:</span> <span id="totalReferralsCount"></span></p><p><span>Paid Shares Today:</span> <span id="paidSharesTodayCount"></span></p><p><span>Earned from Sharing:</span> <span id="referralUsdtEarned"></span></p></div>
                <div class="info-card" id="referralProgramDetailsCard"><h3>Program Details</h3></div>
             </div>
        </div>
        <div id="withdrawScreen" class="screen">
            <div class="app-header"><div class="title">Withdraw</div></div>
            <div class="content-padding">
                <div class="info-card"><p><span>Available Balance:</span> <span id="withdrawUserBalance" style="font-size:16px; color:#34c759;"></span></p></div>
                <div class="info-card"><h3>Request Withdrawal</h3>
                    <div class="form-group"><label>Method:</label><select id="withdrawalMethod"><option value="">Loading...</option></select></div>
                    <div class="form-group"><label>Amount (USDT):</label><input type="number" id="withdrawalAmount" placeholder="Enter amount"></div>
                    <div class="form-group"><label>Account/Wallet Address:</label><input type="text" id="withdrawalAddress" placeholder="Enter address"></div>
                    <button id="submitWithdrawalButton" class="btn">Submit</button>
                </div>
            </div>
        </div>
        <div id="profileScreen" class="screen">
            <div class="app-header"><div class="title">Profile</div></div>
            <div class="content-padding">
                <div class="info-card"><h3>User Profile</h3>
                    <p><span>Name:</span> <span id="profileTabUserName"></span></p>
                    <p><span>Phone:</span> <span id="profileTabUserPhone"></span></p>
                    <p><span>Email:</span> <span id="profileTabUserEmail"></span></p>
                    <p><span>Balance (USDT):</span> <span id="profileTabUserBalance"></span></p>
                    <p><span>Last Active:</span> <span id="profileTabLastActiveDate"></span></p>
                    <button class="btn" style="background-color: #ff3b30; margin-top: 20px;" id="profileLogoutButton">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <a href="#" id="telegramContactLink" target="_blank" class="telegram-contact-fab">
        <svg viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.17.91-.494 1.204-1.07 1.23-.928.043-1.348-.602-2.018-1.028-.91-.588-1.428-.945-2.326-1.528-.986-.631-.339-1.001.221-1.591.133-.142 2.568-2.295 2.568-2.295s.23-.205-.065-.455c-.294-.25-.728-.094-.728-.094L8.44 13.288c-.04.023-.075.045-.117.075l-.105.061s-.37.253-.947.031c-.578-.223-.994-.37-1.128-.409-.426-.12-.76-.182-.756-.532.003-.237.207-.404.512-.584 2.813-1.656 4.593-2.671 4.593-2.671s1.033-.622 2.001-.626zm-2.448 8.528l.618-2.997-.026.018s1.631 1.496 2.017 1.831l.015.012s.313.241.303-.255l-.008-.081L18.3 7.588s.096-.515-.578-.266l-10.84 3.862s-.76.295-.865.995l.01.022s.273.92.855.712L7.89 12.3s.374-.115.864.075l.008.004-3.264 2.957s-.396.358.083.585c.48.226 1.088-.08 1.088-.08l3.829-2.653.86.793 1.108 1.021s.182.153.359.034c.176-.118.173-.25.173-.25z"/></svg>
    </a>

    <div class="bottom-nav">
        <div class="nav-item active" data-screen="homeScreen"><div class="icon">🏠</div><div>Home</div></div>
        <div class="nav-item" data-screen="earnScreen"><div class="icon">💰</div><div>Earn</div></div>
        <div class="nav-item" data-screen="referScreen"><div class="icon">👥</div><div>Refer</div></div>
        <div class="nav-item" data-screen="withdrawScreen"><div class="icon">💸</div><div>Withdraw</div></div>
        <div class="nav-item" data-screen="profileScreen"><div class="icon">👤</div><div>Profile</div></div>
    </div>

<script>
// অনুগ্রহ করে এখানে আপনার নিজের ফায়ারবেস কনফিগারেশন কী (keys) ব্যবহার করুন
const firebaseConfig = {
    apiKey: "AIzaSyAgvOSJFY8WqRoVXRWjWiOEdAmjvTz_pgU",
    authDomain: "task-app-a3b8a.firebaseapp.com",
    databaseURL: "https://task-app-a3b8a-default-rtdb.firebaseio.com",
    projectId: "task-app-a3b8a",
    storageBucket: "task-app-a3b8a.firebasestorage.app",
    messagingSenderId: "154506156460",
    appId: "1:154506156460:web:78124e37a074fe43218209",
    measurementId: "G-Q2C5BLCWDT"
};

// --- App Initialization ---
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const fieldValue = firebase.firestore.FieldValue;

// --- Global State ---
let appState = {};
let appConfig = {};
let autoTaskInterval = null;
let unsubscribeUserListener = null;

// --- DOM Elements ---
const authContainer = document.getElementById('authContainer');
const appContainer = document.querySelector('.app-container');
const screens = document.querySelectorAll('.app-container .screen');
const navItems = document.querySelectorAll('.bottom-nav .nav-item');

// --- Auth Related Functions ---
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const loginButton = document.getElementById('loginButton');
const signupButton = document.getElementById('signupButton');
const showSignup = document.getElementById('showSignup');
const showLogin = document.getElementById('showLogin');
const loginCard = document.getElementById('loginCard');
const signupCard = document.getElementById('signupCard');
const loginError = document.getElementById('loginError');
const signupError = document.getElementById('signupError');

function showLoginForm() {
    loginCard.style.display = 'block';
    signupCard.style.display = 'none';
    loginError.textContent = '';
}

function showSignupForm() {
    loginCard.style.display = 'none';
    signupCard.style.display = 'block';
    signupError.textContent = '';
}

async function handleSignup(e) {
    e.preventDefault();
    const name = signupForm['signupName'].value.trim();
    const email = signupForm['signupEmail'].value.trim();
    const password = signupForm['signupPassword'].value;
    const confirmPassword = signupForm['signupConfirmPassword'].value;

    if (password !== confirmPassword) {
        signupError.textContent = 'Passwords do not match.';
        return;
    }

    signupError.textContent = '';
    signupButton.disabled = true;
    signupButton.textContent = 'Creating Account...';

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        await user.updateProfile({ displayName: name });
        // Firestore document will be created by the auth state observer
    } catch (error) {
        signupError.textContent = getAuthErrorMessage(error.code);
    } finally {
        signupButton.disabled = false;
        signupButton.textContent = 'Sign Up';
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const email = loginForm['loginEmail'].value.trim();
    const password = loginForm['loginPassword'].value;

    loginError.textContent = '';
    loginButton.disabled = true;
    loginButton.textContent = 'Logging In...';

    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        loginError.textContent = getAuthErrorMessage(error.code);
    } finally {
        loginButton.disabled = false;
        loginButton.textContent = 'Login';
    }
}

function handleLogout() {
    if (unsubscribeUserListener) {
        unsubscribeUserListener();
        unsubscribeUserListener = null;
    }
    auth.signOut();
}

function getAuthErrorMessage(code) {
    switch (code) {
        case 'auth/user-not-found': return 'No account found with this email.';
        case 'auth/wrong-password': return 'Incorrect password.';
        case 'auth/email-already-in-use': return 'This email is already registered.';
        case 'auth/weak-password': return 'Password must be at least 6 characters.';
        case 'auth/invalid-email': return 'Please enter a valid email address.';
        default: return 'An error occurred. Please try again.';
    }
}

// --- Core App Logic ---

async function fetchAdminConfig() {
    try {
        const configDoc = await db.collection('config').doc('appSettings').get();
        if (configDoc.exists) {
            appConfig = configDoc.data();
        } else {
            console.warn("Admin config not found. Using default values.");
            appConfig = { dailyTaskLimit: 1000, rewardPerTaskUSD: 0.0006, adZone: '9344336', referralRewardUSDT: 0.10, maxPaidSharesPerDay: 5, withdrawalMethods: [], contactTelegramUrl: '#' };
        }
    } catch (error) {
        console.error("Error fetching admin config:", error);
    }
}

async function initializeUserSession(user) {
    const userRef = db.collection('users').doc(user.uid);
    if (unsubscribeUserListener) unsubscribeUserListener();

    // Create user document if it doesn't exist
    const doc = await userRef.get();
    if (!doc.exists) {
        const newUserState = {
            uid: user.uid, email: user.email, name: user.displayName,
            balanceUSDT: 0.0, createdAt: fieldValue.serverTimestamp(),
            lastLogin: fieldValue.serverTimestamp(), isDisabled: false,
            todayStats: { date: new Date().toDateString(), monetagTasksCompleted: 0, referralSharesToday: 0 },
            referralData: { userIdForReferral: `ref_${user.uid.substring(0, 8)}`, totalReferralsInitiated: 0, usdtEarnedFromReferrals: 0.0, processingShareReward: false }
        };
        await userRef.set(newUserState);
    }

    // Set up real-time listener
    unsubscribeUserListener = userRef.onSnapshot(async (doc) => {
        appState = doc.data();
        if (appState.isDisabled) {
            alert("Your account has been disabled.");
            handleLogout();
            return;
        }

        const today = new Date().toDateString();
        if (appState.todayStats.date !== today) {
            await userRef.update({
                'todayStats.date': today,
                'todayStats.monetagTasksCompleted': 0,
                'todayStats.referralSharesToday': 0
            });
        } else {
            updateAllDisplays();
        }
    }, console.error);

    await userRef.update({ lastLogin: fieldValue.serverTimestamp() });
}

function showScreen(screenId) {
    screens.forEach(s => s.classList.remove('active'));
    document.getElementById(screenId)?.classList.add('active');
    navItems.forEach(n => n.classList.toggle('active', n.dataset.screen === screenId));
    updateAllDisplays();
}

// --- UI Update Functions ---

function updateAllDisplays() {
    if (!appState || !appConfig) return;
    updateHeadersAndProfile();
    updateEarnScreen();
    updateReferralScreen();
    updateWithdrawScreen();
}

function updateHeadersAndProfile() {
    const name = appState.name || "User";
    const balance = (appState.balanceUSDT || 0).toFixed(4);
    const email = appState.email || 'N/A';
    const lastActive = appState.lastLogin ? new Date(appState.lastLogin.seconds * 1000).toLocaleDateString() : 'N/A';
    const avatarSrc = createDefaultAvatar(name.charAt(0));

    // Headers
    document.getElementById('headerUserAvatar').src = avatarSrc;
    document.getElementById('headerUserName').textContent = name;
    document.getElementById('profileSummaryUserAvatar').src = avatarSrc;
    document.getElementById('profileSummaryUserName').textContent = name;
    document.getElementById('profileSummaryUserBalance').textContent = `Balance: ${balance} USDT`;
    
    // Profile Tab
    document.getElementById('profileTabUserName').textContent = name;
    document.getElementById('profileTabUserEmail').textContent = email;
    document.getElementById('profileTabUserBalance').textContent = balance;
    document.getElementById('profileTabLastActiveDate').textContent = lastActive;
    
    // Home Screen
    document.getElementById('homeTotalMonetagEarnings').textContent = balance;
}

function updateEarnScreen() {
    const limit = appConfig.dailyTaskLimit || 0;
    const completed = appState.todayStats?.monetagTasksCompleted || 0;
    const remaining = Math.max(0, limit - completed);
    
    document.getElementById('earnMonetagDailyLimit').textContent = limit;
    document.getElementById('earnMonetagCompletedToday').textContent = completed;
    document.getElementById('earnMonetagRemainingToday').textContent = remaining;
    document.getElementById('homeMonetagDailyLimit').textContent = limit;
    document.getElementById('homeMonetagTasksCompleted').textContent = completed;
    
    const startButton = document.getElementById('startTaskMonetagButton');
    startButton.disabled = remaining <= 0;
    startButton.textContent = remaining > 0 ? `Start Task Monetag (${remaining} left)` : 'Daily Tasks Completed';
    document.getElementById('autoTaskCompleteButton').disabled = remaining <= 0;
}

function updateReferralScreen() {
    const botBaseUrl = "https://t.me/My_Earning20BD_bot/YourAppName?startapp=";
    document.getElementById('referralLink').value = appState.referralData ? `${botBaseUrl}${appState.referralData.userIdForReferral}` : "";
    document.getElementById('totalReferralsCount').textContent = appState.referralData?.totalReferralsInitiated || 0;
    document.getElementById('paidSharesTodayCount').textContent = `${appState.todayStats?.referralSharesToday || 0}/${appConfig.maxPaidSharesPerDay || 0}`;
    document.getElementById('referralUsdtEarned').textContent = `${(appState.referralData?.usdtEarnedFromReferrals || 0).toFixed(4)} USDT`;

    const detailsCard = document.getElementById('referralProgramDetailsCard');
    detailsCard.innerHTML = `<h3>Program Details</h3>
        <p class="referral-details-text">Earn <strong>$${(appConfig.referralRewardUSDT || 0).toFixed(2)} USDT</strong> for each of the first <strong>${appConfig.maxPaidSharesPerDay || 0} shares/copies</strong> per day.</p>
        <p class="referral-details-text">Reward is added <strong>1 minute after</strong> sharing/copying.</p>`;
}

function updateWithdrawScreen() {
    document.getElementById('withdrawUserBalance').textContent = `${(appState.balanceUSDT || 0).toFixed(4)} USDT`;
    const methodSelect = document.getElementById('withdrawalMethod');
    methodSelect.innerHTML = '<option value="">Select a method</option>';
    (appConfig.withdrawalMethods || []).forEach(method => {
        if (method.enabled) {
            const option = document.createElement('option');
            option.value = method.name.toLowerCase();
            option.textContent = `${method.name} (Min. ${method.min} USDT)`;
            option.dataset.min = method.min;
            methodSelect.appendChild(option);
        }
    });
}

// --- Feature Functions ---

function showMonetagAd() {
    const limit = appConfig.dailyTaskLimit || 0;
    const completed = appState.todayStats?.monetagTasksCompleted || 0;
    if (completed >= limit) {
        document.getElementById('adStatusMessage').textContent = "Daily task limit reached.";
        return;
    }

    document.getElementById('adStatusMessage').textContent = "Loading ad...";
    document.getElementById('startTaskMonetagButton').disabled = true;

    const adFunction = `show_${appConfig.adZone || '9344336'}`;
    if (typeof window[adFunction] === 'function') {
        window[adFunction]().then(() => {
            document.getElementById('adStatusMessage').textContent = "Task completed successfully!";
            const userRef = db.collection('users').doc(auth.currentUser.uid);
            userRef.update({
                'todayStats.monetagTasksCompleted': fieldValue.increment(1),
                'balanceUSDT': fieldValue.increment(appConfig.rewardPerTaskUSD || 0)
            });
            setTimeout(() => document.getElementById('adStatusMessage').textContent = "", 2000);
        }).catch(() => {
            document.getElementById('adStatusMessage').textContent = "Ad failed or was cancelled.";
            document.getElementById('startTaskMonetagButton').disabled = false;
        });
    } else {
        document.getElementById('adStatusMessage').textContent = "Ad SDK not ready.";
    }
}

function startAutoTask() {
    stopAutoTask();
    document.getElementById('autoTaskCompleteButton').style.display = 'none';
    document.getElementById('stopAutoTaskButton').style.display = 'block';
    
    showMonetagAd(); // First ad
    autoTaskInterval = setInterval(() => {
        if ((appState.todayStats?.monetagTasksCompleted || 0) >= (appConfig.dailyTaskLimit || 0)) {
            stopAutoTask();
        } else {
            showMonetagAd();
        }
    }, 5000);
}

function stopAutoTask() {
    if (autoTaskInterval) clearInterval(autoTaskInterval);
    autoTaskInterval = null;
    document.getElementById('autoTaskCompleteButton').style.display = 'block';
    document.getElementById('stopAutoTaskButton').style.display = 'none';
}

async function processReferralInitiation(actionType) {
    if (appState.referralData?.processingShareReward) {
        document.getElementById('copyStatusMessage').textContent = "Reward processing, please wait...";
        return;
    }
    const userRef = db.collection('users').doc(auth.currentUser.uid);
    userRef.update({ 'referralData.processingShareReward': true, 'referralData.totalReferralsInitiated': fieldValue.increment(1) });
    document.getElementById('copyStatusMessage').textContent = "Processing reward (wait 1 min)...";

    setTimeout(() => {
        // Re-fetch the latest state to check share count
        userRef.get().then(doc => {
            const latestState = doc.data();
            if ((latestState.todayStats.referralSharesToday || 0) < (appConfig.maxPaidSharesPerDay || 0)) {
                const reward = appConfig.referralRewardUSDT || 0;
                userRef.update({
                    'todayStats.referralSharesToday': fieldValue.increment(1),
                    'referralData.usdtEarnedFromReferrals': fieldValue.increment(reward),
                    'balanceUSDT': fieldValue.increment(reward)
                });
                document.getElementById('copyStatusMessage').textContent = `+${reward.toFixed(2)} USDT earned!`;
            } else {
                document.getElementById('copyStatusMessage').textContent = `Daily reward limit reached.`;
            }
            userRef.update({ 'referralData.processingShareReward': false });
            setTimeout(() => document.getElementById('copyStatusMessage').textContent = "", 3000);
        });
    }, 60000); // 1 minute delay
}

async function submitWithdrawalRequest() {
    const methodSelect = document.getElementById('withdrawalMethod');
    const amount = parseFloat(document.getElementById('withdrawalAmount').value);
    const address = document.getElementById('withdrawalAddress').value.trim();
    const method = methodSelect.value;
    const min = parseFloat(methodSelect.options[methodSelect.selectedIndex]?.dataset.min || 0);
    
    if (!method || !amount || !address) { alert('Please fill all fields.'); return; }
    if (amount < min) { alert(`Minimum withdrawal for ${method} is ${min} USDT.`); return; }
    if (amount > appState.balanceUSDT) { alert('Insufficient balance.'); return; }
    
    document.getElementById('submitWithdrawalButton').disabled = true;
    try {
        await db.collection('withdrawalRequests').add({
            userId: auth.currentUser.uid, userName: appState.name,
            amount, method, address, status: 'pending', timestamp: fieldValue.serverTimestamp()
        });
        await db.collection('users').doc(auth.currentUser.uid).update({ balanceUSDT: fieldValue.increment(-amount) });
        alert('Withdrawal request submitted successfully.');
        document.getElementById('withdrawalAmount').value = '';
        document.getElementById('withdrawalAddress').value = '';
    } catch (error) {
        alert('Error submitting request. Please try again.');
    } finally {
        document.getElementById('submitWithdrawalButton').disabled = false;
    }
}


// --- Utility and Simulation Functions ---
function createDefaultAvatar(letter) {
    const canvas = document.createElement('canvas');
    canvas.width = 80; canvas.height = 80;
    const context = canvas.getContext('2d');
    context.fillStyle = "#007aff";
    context.fillRect(0, 0, 80, 80);
    context.font = `bold 42px Arial`;
    context.fillStyle = "#FFFFFF"; context.textAlign = "center"; context.textBaseline = "middle";
    context.fillText(letter.toUpperCase(), 40, 42);
    return canvas.toDataURL();
}

function startWithdrawalHistoryFeedSimulation() {
    const list = document.getElementById('withdrawalHistoryList');
    setInterval(() => {
        const phone = `01****${Math.floor(1000 + Math.random() * 9000)}`;
        const amount = (Math.random() * 20 + 5).toFixed(2);
        const li = document.createElement('li');
        li.innerHTML = `<span class="phone-number">${phone}</span><span class="amount">${amount} USDT</span><span class="status-success">✓ Success</span>`;
        list.prepend(li);
        if (list.children.length > 5) list.lastChild.remove();
    }, 3500);
}


// --- Event Listeners Initialization ---
function addAllEventListeners() {
    // Auth
    showLogin.addEventListener('click', showLoginForm);
    showSignup.addEventListener('click', showSignupForm);
    loginForm.addEventListener('submit', handleLogin);
    signupForm.addEventListener('submit', handleSignup);
    document.getElementById('logoutButton').addEventListener('click', handleLogout);
    document.getElementById('profileLogoutButton').addEventListener('click', handleLogout);

    // Navigation
    navItems.forEach(item => item.addEventListener('click', () => showScreen(item.dataset.screen)));

    // Features
    document.getElementById('startTaskMonetagButton').addEventListener('click', showMonetagAd);
    document.getElementById('autoTaskCompleteButton').addEventListener('click', startAutoTask);
    document.getElementById('stopAutoTaskButton').addEventListener('click', stopAutoTask);
    document.getElementById('submitWithdrawalButton').addEventListener('click', submitWithdrawalRequest);
    document.getElementById('copyReferralLinkButton').addEventListener('click', () => {
        navigator.clipboard.writeText(document.getElementById('referralLink').value);
        processReferralInitiation('copy');
    });
    document.getElementById('shareReferralLinkButton').addEventListener('click', () => {
        processReferralInitiation('share');
        const link = document.getElementById('referralLink').value;
        window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}`);
    });
}

// --- Main Execution Flow ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        authContainer.style.display = 'none';
        await fetchAdminConfig();
        await initializeUserSession(user);
        appContainer.style.display = 'flex'; // Use flex for proper layout
        showScreen('homeScreen');
    } else {
        appContainer.style.display = 'none';
        authContainer.style.display = 'flex';
        showLoginForm();
    }
});

window.onload = () => {
    addAllEventListeners();
    startWithdrawalHistoryFeedSimulation();
};

</script>
</body>
</html>
